(()=>{"use strict";var e={7:e=>{var t,n="object"==typeof Reflect?Reflect:null,i=n&&"function"==typeof n.apply?n.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};t=n&&"function"==typeof n.ownKeys?n.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var r=Number.isNaN||function(e){return e!=e};function o(){o.init.call(this)}e.exports=o,e.exports.once=function(e,t){return new Promise((function(n,i){function r(n){e.removeListener(t,o),i(n)}function o(){"function"==typeof e.removeListener&&e.removeListener("error",r),n([].slice.call(arguments))}f(e,t,o,{once:!0}),"error"!==t&&function(e,t){"function"==typeof e.on&&f(e,"error",t,{once:!0})}(e,r)}))},o.EventEmitter=o,o.prototype._events=void 0,o.prototype._eventsCount=0,o.prototype._maxListeners=void 0;var l=10;function a(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function s(e){return void 0===e._maxListeners?o.defaultMaxListeners:e._maxListeners}function c(e,t,n,i){var r,o,l,c;if(a(n),void 0===(o=e._events)?(o=e._events=Object.create(null),e._eventsCount=0):(void 0!==o.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),o=e._events),l=o[t]),void 0===l)l=o[t]=n,++e._eventsCount;else if("function"==typeof l?l=o[t]=i?[n,l]:[l,n]:i?l.unshift(n):l.push(n),(r=s(e))>0&&l.length>r&&!l.warned){l.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+l.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=e,u.type=t,u.count=l.length,c=u,console&&console.warn&&console.warn(c)}return e}function u(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function d(e,t,n){var i={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},r=u.bind(i);return r.listener=n,i.wrapFn=r,r}function h(e,t,n){var i=e._events;if(void 0===i)return[];var r=i[t];return void 0===r?[]:"function"==typeof r?n?[r.listener||r]:[r]:n?function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(r):g(r,r.length)}function m(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function g(e,t){for(var n=new Array(t),i=0;i<t;++i)n[i]=e[i];return n}function f(e,t,n,i){if("function"==typeof e.on)i.once?e.once(t,n):e.on(t,n);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function r(o){i.once&&e.removeEventListener(t,r),n(o)}))}}Object.defineProperty(o,"defaultMaxListeners",{enumerable:!0,get:function(){return l},set:function(e){if("number"!=typeof e||e<0||r(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");l=e}}),o.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},o.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||r(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},o.prototype.getMaxListeners=function(){return s(this)},o.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var r="error"===e,o=this._events;if(void 0!==o)r=r&&void 0===o.error;else if(!r)return!1;if(r){var l;if(t.length>0&&(l=t[0]),l instanceof Error)throw l;var a=new Error("Unhandled error."+(l?" ("+l.message+")":""));throw a.context=l,a}var s=o[e];if(void 0===s)return!1;if("function"==typeof s)i(s,this,t);else{var c=s.length,u=g(s,c);for(n=0;n<c;++n)i(u[n],this,t)}return!0},o.prototype.addListener=function(e,t){return c(this,e,t,!1)},o.prototype.on=o.prototype.addListener,o.prototype.prependListener=function(e,t){return c(this,e,t,!0)},o.prototype.once=function(e,t){return a(t),this.on(e,d(this,e,t)),this},o.prototype.prependOnceListener=function(e,t){return a(t),this.prependListener(e,d(this,e,t)),this},o.prototype.removeListener=function(e,t){var n,i,r,o,l;if(a(t),void 0===(i=this._events))return this;if(void 0===(n=i[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(r=-1,o=n.length-1;o>=0;o--)if(n[o]===t||n[o].listener===t){l=n[o].listener,r=o;break}if(r<0)return this;0===r?n.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(n,r),1===n.length&&(i[e]=n[0]),void 0!==i.removeListener&&this.emit("removeListener",e,l||t)}return this},o.prototype.off=o.prototype.removeListener,o.prototype.removeAllListeners=function(e){var t,n,i;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0===arguments.length){var r,o=Object.keys(n);for(i=0;i<o.length;++i)"removeListener"!==(r=o[i])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(i=t.length-1;i>=0;i--)this.removeListener(e,t[i]);return this},o.prototype.listeners=function(e){return h(this,e,!0)},o.prototype.rawListeners=function(e){return h(this,e,!1)},o.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):m.call(e,t)},o.prototype.listenerCount=m,o.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]}},707:(e,t,n)=>{n.r(t),n.d(t,{default:()=>i});const i="#config-popup-container * {\r\n  margin: 0;\r\n  padding: 0;\r\n  box-sizing: border-box;\r\n  font-family: Arial, Helvetica, sans-serif;\r\n  color: black;\r\n}\r\n\r\n#config-popup-header {\r\n  margin-bottom: 24px;\r\n  text-shadow: 2px 2px 2px gray;\r\n}\r\n\r\n#config-popup-container {\r\n  position: absolute;\r\n  top: 50%;\r\n  left: 50%;\r\n  transform: translate(-50%, -50%);\r\n  box-shadow: 0px 3px 8px 0px rgba(157, 157, 157, 0.4);\r\n  border-radius: 4px;\r\n  width: 350px;\r\n  max-width: 80%;\r\n  overflow: hidden;\r\n  background-color: antiquewhite;\r\n  border: 1px solid rgba(165, 125, 11, 1);\r\n  z-index: 100;\r\n  padding: 16px;\r\n}\r\n\r\n.input-wrapper {\r\n  display: grid;\r\n  grid-template-columns: auto 1fr;\r\n  justify-items: start;\r\n  column-gap: 8px;\r\n  row-gap: 8px;\r\n  align-items: center;\r\n  margin-top: 16px;\r\n  text-align: start;\r\n}\r\n\r\n.input-wrapper label {\r\n  background-color: none;\r\n}\r\n\r\n.expandable-section {\r\n  grid-column-start: 2;\r\n}\r\n\r\n#config-popup-content {\r\n  display: flex;\r\n  flex-direction: column;\r\n  border-radius: 4px;\r\n  gap: 8px;\r\n}\r\n\r\n#config-popup-content h1 {\r\n  font-weight: 500;\r\n  font-size: 1.7rem;\r\n  align-self: center;\r\n  margin-bottom: 8px;\r\n}\r\n\r\n.label-chevron {\r\n  display: flex;\r\n  align-items: center;\r\n  gap:8px\r\n}\r\n\r\n\r\n#button-panel {\r\n  align-self: flex-end;\r\n  margin-top: 20px;\r\n}\r\n\r\n#button-panel button {\r\n  padding: 4px;\r\n  cursor: pointer;\r\n}\r\n\r\n#config-popup-container.minimized {\r\n  top: auto;\r\n  transform: none;\r\n  bottom: 50px;\r\n  left: 10px;\r\n  width: 40px;\r\n  height: 40px;\r\n  border-radius: 50%;\r\n  box-shadow: none;\r\n}\r\n\r\n\r\n.show-trigger {\r\n  display: none;\r\n}\r\n\r\n#close-popup {\r\n  cursor: pointer;\r\n  position: absolute;\r\n  right: 10px;\r\n  top: 10px;\r\n  transition-duration: 125ms;\r\n  color: tomato;\r\n  text-shadow: 0px 0px 2px black;\r\n}\r\n\r\n#close-popup:hover {\r\n  animation: freak 1s ease-in both infinite;\r\n}\r\n\r\n#config-popup-container.minimized #config-popup-content {\r\n  display: none;\r\n}\r\n\r\n#config-popup-container.minimized #config-popup-header {\r\n  display: none;\r\n}\r\n\r\n#config-popup-container.minimized {\r\n  padding: 0;\r\n}\r\n\r\n#config-popup-container.minimized .show-trigger {\r\n  cursor: pointer;\r\n  width: 100%;\r\n  height: 100%;\r\n  display: flex;\r\n  align-items: center;\r\n  justify-content: center;\r\n  font-size: 0.7rem;\r\n  font-weight: 600;\r\n  text-shadow: 0px 1px 1px rgba(165, 125, 11, 1);\r\n}\r\n\r\n.section-header {\r\n  display: flex;\r\n  flex-direction: row;\r\n  align-items: center;\r\n  gap: 5px;\r\n}\r\n\r\n.section-content {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 4px;\r\n}\r\n\r\n.isle-container {\r\n  display: flex;\r\n  margin-left: 16px !important;\r\n  gap: 4px;\r\n  margin-top: 4px !important;\r\n}\r\n\r\n.arrow-down {\r\n  cursor: pointer;\r\n}\r\n\r\n.hidden {\r\n  display: none !important;\r\n}\r\n\r\n.rotate {\r\n  transform: rotate(180deg);\r\n}\r\n\r\n@keyframes freak {\r\n  0% {\r\n    transform: scale(1);\r\n  }\r\n\r\n  33.33% {\r\n    transform: scale(0.8);\r\n  }\r\n\r\n  66.66% {\r\n    transform: scale(1.2);\r\n  }\r\n}"},13:(e,t,n)=>{n.r(t),n.d(t,{default:()=>i});const i='<div id="config-popup-container" class="">\r\n  <div id="config-popup-header">\r\n    <h1>GPS config</h1>\r\n    <div id="close-popup">&#10006;</div>\r\n  </div>\r\n  <div id="config-popup-content">\r\n    <div class="input-wrapper">\r\n      <input type="checkbox" id="farm" checked />\r\n      <div class="label-chevron">\r\n        <label for="farm">\r\n          Farm manager\r\n        </label>\r\n        <svg xmlns="http://www.w3.org/2000/svg" class="arrow-down" width="16" height="16" fill="currentColor"\r\n          class="bi bi-chevron-down" viewBox="0 0 16 16">\r\n          <path fill-rule="evenodd"\r\n            d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708" />\r\n        </svg>\r\n      </div>\r\n      <div class="expandable-section hidden">\r\n        <div class="section-header"></div>\r\n        <div class="section-content">\r\n          <div class="input-wapper">\r\n            <label>\r\n              Time interval\r\n            </label>\r\n            <select id="time-interval-select">\r\n            </select>\r\n          </div>\r\n          <div class="input-wapper">\r\n            <input type="checkbox" id="humanize-checkbox" />\r\n            <label for="humanize-checkbox">\r\n              Humanize\r\n            </label>\r\n          </div>\r\n          <div id="conflicting-cities-container" class="hidden">\r\n            <div class="section-header">\r\n              <span class="section-name">Conflicting cities</span>\r\n              <svg xmlns="http://www.w3.org/2000/svg" class="arrow-down" width="16" height="16" fill="currentColor"\r\n                class="bi bi-chevron-down" viewBox="0 0 16 16">\r\n                <path fill-rule="evenodd"\r\n                  d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708" />\r\n              </svg>\r\n            </div>\r\n            <div class="section-content hidden">\r\n              \x3c!-- <div class="isle-container">\r\n                <div class="isle-header">Isle 1</div>\r\n                <select name="isle1-cities" id="isle1-cities">\r\n                  <option value="city1">City 1</option>\r\n                  <option value="city2">City 2</option>\r\n                </select>\r\n              </div> --\x3e\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n    <div class="input-wrapper">\r\n      <input type="checkbox" id="builder" />\r\n      <label for="builder">Builder</label>\r\n    </div>\r\n    <div class="input-wrapper">\r\n      <input type="checkbox" id="recruiter" />\r\n      \x3c!-- <label for="recruiter">Recruiter (in progress)</label> --\x3e\r\n      <div class="label-chevron">\r\n        <label for="recruiter">\r\n          Recruiter\r\n        </label>\r\n        <svg xmlns="http://www.w3.org/2000/svg" class="arrow-down" width="16" height="16" fill="currentColor"\r\n          class="bi bi-chevron-down" viewBox="0 0 16 16">\r\n          <path fill-rule="evenodd"\r\n            d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708" />\r\n        </svg>\r\n      </div>\r\n      <div class="expandable-section hidden">\r\n        <div class="section-header"></div>\r\n        <div class="section-content">\r\n          <div class="input-wapper">\r\n            <input type="checkbox" id="recruiter-auto-reevaluate" />\r\n            <label for="recruiter-auto-reevaluate">Prevent conflicts</label>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n    <div class="input-wrapper">\r\n      <input type="checkbox" id="guard" disabled />\r\n      <label for="guard">Guard (in progress)</label>\r\n    </div>\r\n\r\n    <div id="button-panel">\r\n      <button id="submit">Submit</button>\r\n      <button type="reset" id="cancel-all">Cancel all</button>\r\n    </div>\r\n  </div>\r\n  <div class="show-trigger">\r\n    GPS\r\n  </div>\r\n</div>'},165:(e,t,n)=>{n.r(t),n.d(t,{default:()=>i});const i='<div id="build-container" class="hidden">\r\n  <div id="build-options">\r\n  </div>\r\n  <div id="additional-queue">\r\n\r\n  </div>\r\n</div>\r\n<button id="toggle-builder" class="hidden">Toggle builder</button>'},77:(e,t,n)=>{n.r(t),n.d(t,{default:()=>i});const i="#additional-queue {\r\n  display: flex;\r\n  gap: 8px;\r\n  box-shadow: 0 0 10px 0 rgba(0, 0, 0, 0.5);\r\n  border-radius: 4px;\r\n  padding: 4px;\r\n  max-width: 568px;\r\n  width: fit-content;\r\n  overflow-y: auto;\r\n  font-family: Arial, Helvetica, sans-serif;\r\n}\r\n\r\n.queue-item {\r\n  flex-shrink: 0;\r\n  position: relative;\r\n  width: 45px;\r\n  height: 45px;\r\n  background-size: cover;\r\n  background-position: center;\r\n}\r\n\r\n.queue-item .up {\r\n  position: absolute;\r\n  bottom: 0;\r\n  left: 0;\r\n  right: 0;\r\n  font-weight: bold;\r\n  color: lightgreen;\r\n  text-align: end;\r\n  margin: 2px;\r\n  font-size: 12px;\r\n  background-color: rgba(0, 0, 0, 0.4);\r\n}\r\n\r\n.queue-item .cancel {\r\n  position: absolute;\r\n  top: 0;\r\n  right: 0;\r\n  font-weight: bold;\r\n  color: red;\r\n  cursor: pointer;\r\n  padding: 1px;\r\n  font-size: 10px;\r\n}\r\n\r\n.queue-item .cancel:hover {\r\n  transform: scale(1.4);\r\n  transition: all 0.2s ease;\r\n}\r\n\r\nhidden {\r\n  display: none;\r\n}\r\n\r\n#build-container {\r\n  z-index: 2000;\r\n  display: flex;\r\n  flex-direction: column;\r\n  align-items: center;\r\n  gap: 8px;\r\n  position: fixed;\r\n  bottom: 80px;\r\n  left: 50%;\r\n  transform: translateX(-50%);\r\n  border: 1px solid darkgoldenrod;\r\n  border-radius: 4px;\r\n  padding: 4px;\r\n  overflow-x: auto;\r\n  max-width: 90%;\r\n  background-color: bisque;\r\n  width: fit-content;\r\n}\r\n\r\n#build-options {\r\n  display: flex;\r\n  gap: 4px;\r\n}\r\n\r\n.build-option {\r\n  position: relative;\r\n  width: 40px;\r\n  height: 40px;\r\n  background-size: cover;\r\n  background-position: center;\r\n  cursor: pointer;\r\n}\r\n\r\n.build-option:hover {\r\n  transform: scale(1.1);\r\n  transition: all 0.2s ease;\r\n}\r\n\r\n.build-options-add {\r\n  position: absolute;\r\n  top: 50%;\r\n  right: 50%;\r\n  transform: translate(50%, -50%);\r\n  font-weight: bold;\r\n  color: white;\r\n  cursor: pointer;\r\n  font-size: 16px;\r\n  user-select: none;\r\n}\r\n\r\n#toggle-builder {\r\n  cursor: pointer;\r\n  position: fixed;\r\n  bottom: 15px;\r\n  left: 50%;\r\n  transform: translateX(-50%);\r\n  font-size: 12px;\r\n  z-index: 1000;\r\n  opacity: 0.6;\r\n}\r\n\r\n#toggle-builder:hover {\r\n  opacity: 1;\r\n}"},39:(e,t,n)=>{n.r(t),n.d(t,{default:()=>i});const i="#info-container {\r\n  z-index: 3000 !important;\r\n  font-family: 'Roboto', sans-serif;\r\n  font-size: 0.9em;\r\n  position: absolute;\r\n  top: 10%;\r\n  left: 50%;  \r\n  transform: translateX(-50%);\r\n  background-color: rgba(1, 11, 152, 0.6); /* Zmiana na rgba z opacity 0.8 */\r\n  color: #fff;\r\n  padding: 5px 20px;\r\n  box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);\r\n  display: block;\r\n}\r\n\r\n.info-title {\r\n  font-weight: bold;\r\n}\r\n\r\n#info-container.hidden {\r\n  display: block;\r\n  animation: slideOut 0.4s;\r\n  animation-fill-mode: forwards;\r\n}\r\n\r\n@keyframes slideIn {\r\n  0% {\r\n    opacity: 0;\r\n    transform: translateX(-50%) translateY(-100%);\r\n  }\r\n  80% {\r\n    transform: translateX(-50%) translateY(20%);\r\n  }\r\n  100% {\r\n    opacity: 1;\r\n    transform: translateX(-50%) translateY(0);\r\n  }\r\n}\r\n\r\n@keyframes slideOut {\r\n  0% {\r\n    display: block;\r\n    opacity: 1;\r\n  }\r\n  100% {\r\n    opacity: 0;\r\n    display: none;\r\n    transform: translateX(0%) translateY(0);\r\n  }\r\n} \r\n"},41:(e,t,n)=>{n.r(t),n.d(t,{default:()=>i});const i='<div id="info-container" class="hidden">\r\n  <span class="info-title"></span>\r\n  <span class="info-text"></span>\r\n</div>'},11:(e,t,n)=>{n.r(t),n.d(t,{default:()=>i});const i='<div id="recruiter-dialog" hidden>\r\n  <nav id="recruiter-nav">\r\n    <button type="button" id="recruiter-close-btn">x</button>\r\n  </nav>\r\n  <div class="recruiter-dialog-header">\r\n    <div style="display: flex; align-items: center; gap: 4px">\r\n      <h2>Recruiter</h2>\r\n      <svg class="recruiter-dialog-header-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24"\r\n        height="24">\r\n        <path\r\n          d="M12 20q-3.35 0-5.675-2.325Q4 15.35 4 12q0-3.35 2.325-5.675Q8.65 4 12 4q1.725 0 3.3.713 1.575.712 2.7 2.037V4h2v7h-7V9h4.2q-.8-1.4-2.187-2.2Q13.625 6 12 6 9.5 6 7.75 7.75T6 12q0 2.5 1.75 4.25T12 18q1.925 0 3.475-1.1T17.65 14h2.1q-.7 2.65-2.85 4.325Q14.75 20 12 20Z" />\r\n      </svg>\r\n    </div>\r\n    \x3c!-- <button type="button" id="recruiter-close-btn">x</button> --\x3e\r\n    <div id="current-unit-image"></div>\r\n  </div>\r\n  <div class="recruiter-dialog-content">\r\n    <div class="recruiter-type-section">\r\n      <h2>Recruitment amount type</h2>\r\n      <div class="input-wrapper">\r\n        <label for="recruiter-type-units">Units</label>\r\n        <input type="radio" id="recruiter-type-units" value="units" name="recruiter-type">\r\n      </div>\r\n      <div class="input-wrapper">\r\n        <label for="recruiter-type-slots">Slots</label>\r\n        <input type="radio" checked id="recruiter-type-slots" value="slots" name="recruiter-type">\r\n      </div>\r\n    </div>\r\n\r\n    <div class="recruiter-ammount-section">\r\n      <h2>Amount</h2>\r\n      <div class="input-wrapper">\r\n        <label for="recruiter-ammount">Units/Slots</label>\r\n        <input disabled type="number" id="recruiter-ammount" name="recruiter-ammount">\r\n      </div>\r\n      <div class="input-wrapper">\r\n        <label for="recruiter-amount-max">Max</label>\r\n        <input type="checkbox" checked id="recruiter-amount-max" value="max" name="recruiter-amount-max">\r\n      </div>\r\n    </div>\r\n\r\n    <div class="recruiter-cities-section">\r\n      <h2>Take resources from cities</h2>\r\n      <p id="recruiter-cities-list"></p>\r\n      <div class="input-wrapper">\r\n        <label for="recruiter-cities">Cities</label>\r\n        <select name="recruiter-cities" id="recruiter-cities" multiple size="0">\r\n        </select>\r\n      </div>\r\n      <div class="input-wrapper" style="margin-top: 8px;">\r\n        <label for="shipment-time">Max shipment time</label>\r\n        <select id="shipment-time" name="shipment-time">\r\n          <option value="300000">5 min</option>\r\n          <option value="600000">10 min</option>\r\n          <option value="900000">15 min</option>\r\n          <option value="1200000">20 min</option>\r\n          <option value="1500000" selected>25 min</option>\r\n          <option value="1800000">30 min</option>\r\n          <option value="2100000">35 min</option>\r\n          <option value="2400000">40 min</option>\r\n          <option value="2700000">45 min</option>\r\n          <option value="3000000">50 min</option>\r\n          <option value="3300000">55 min</option>\r\n          <option value="3600000">60 min</option>\r\n        </select>\r\n      </div>\r\n    </div>\r\n\r\n    <div class="recruiter-queue-section">\r\n      <h2>Queue</h2>\r\n      <div id="recruiter-queue-content"></div>\r\n    </div>\r\n\r\n    <div class="recruiter-buttons-section">\r\n      <button type="reset" id="recruiter-cancel-btn">Cancel all</button>\r\n      <button type="button" id="recruiter-add-btn">Add</button>\r\n      <button type="submit" id="recruiter-confirm-btn">Confirm</button>\r\n    </div>\r\n  </div>\r\n</div>'},881:(e,t,n)=>{n.r(t),n.d(t,{default:()=>i});const i='<button type="button" id="recruiter-btn">recruiter</button>'},319:(e,t,n)=>{n.r(t),n.d(t,{default:()=>i});const i='#recruiter-btn {\r\n  margin-bottom: 16px;\r\n}\r\n\r\n#recruiter-dialog {\r\n  text-align: left;\r\n  z-index: 2000 !important;\r\n  box-sizing: border-box;\r\n  position: absolute;\r\n  /* top: 50%;\r\n  left: 50%;\r\n  transform: translate(-50%, -50%); */\r\n  left: 670px;\r\n  top: 200px;\r\n  width: 500px;\r\n  max-height: 500px;\r\n  overflow-y: auto;\r\n  background-color: bisque;\r\n  padding: 16px;\r\n  border: 1px solid black;\r\n}\r\n\r\n#recruiter-dialog * {\r\n  /* box-sizing: border-box; */\r\n  padding: 0;\r\n  margin: 0;\r\n  font-family: "Roboto", sans-serif;\r\n}\r\n\r\n#recruiter-dialog h2 {\r\n  font-size: 1.1rem;\r\n  font-weight: 600;\r\n  text-shadow: 1px 1px 1px rgba(73, 73, 73, 0.5);\r\n}\r\n\r\n#recruiter-dialog #recruiter-nav {\r\n  z-index: 2000;\r\n  display: flex;\r\n  justify-content: flex-end;\r\n  height: 28px;\r\n  align-items: center;\r\n  cursor: grab;\r\n  margin: -16px -16px 0 -16px;\r\n  background-color: burlywood;\r\n  position: sticky;\r\n  top: -17px;\r\n}\r\n\r\n#recruiter-dialog #recruiter-close-btn {\r\n  /* position: absolute;\r\n  top: 8px;\r\n  right: 8px; */\r\n  width: 24px;\r\n  height: 24px;\r\n  cursor: pointer;\r\n}\r\n\r\n#recruiter-dialog .recruiter-dialog-header {\r\n  /* background-color: brown; */\r\n}\r\n\r\n#recruiter-dialog .recruiter-dialog-header-icon {\r\n  cursor: pointer;\r\n}\r\n\r\n#recruiter-dialog .recruiter-dialog-header-icon:hover {\r\n  /* animation: rotate .5s linear infinite;\r\n  fill: rgba(0, 0, 0, 0.7); */\r\n  transform: scale(1.1);\r\n  transition: transform .1s ease;\r\n}\r\n\r\n@keyframes rotate {\r\n  0% {\r\n    transform: rotate(0deg);\r\n  }\r\n\r\n  100% {\r\n    transform: rotate(360deg);\r\n  }\r\n}\r\n\r\n#recruiter-dialog #current-unit-image {\r\n  width: 48px;\r\n  height: 48px;\r\n  background-color: blue;\r\n}\r\n\r\n\r\n#recruiter-dialog .recruiter-dialog-content {\r\n  margin-top: 8px;\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 8px;\r\n  /* background-color: azure; */\r\n}\r\n\r\n#recruiter-dialog #recruiter-type-content {\r\n  /* background-color: aquamarine; */\r\n}\r\n\r\n#recruiter-dialog .input-wrapper {\r\n  display: flex;\r\n  align-items: center;\r\n  /* background-color: blueviolet; */\r\n  gap: 4px;\r\n}\r\n\r\n\r\n/* #recruiter-dialog .recruiter-ammount-section {} */\r\n#recruiter-dialog .recruiter-ammount-section input[name="recruiter-ammount"] {\r\n  max-width: 54px;\r\n}\r\n\r\n/* #recruiter-dialog .recruiter-cities-section {} */\r\n#recruiter-dialog #recruiter-cities {\r\n  padding: 4px;\r\n}\r\n\r\n#recruiter-dialog #recruiter-cities option {\r\n  padding: 4px;\r\n}\r\n\r\n#recruiter-dialog #recruiter-cities-list {\r\n  color: gray;\r\n  font-size: 0.8rem;\r\n  margin-bottom: 8px;\r\n}\r\n\r\n#recruiter-dialog #recruiter-queue-content {\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 4px;\r\n}\r\n\r\n#recruiter-dialog .recruiter-queue-item {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 4px;\r\n}\r\n\r\n#recruiter-dialog .recruiter-queue-item-image {\r\n  width: 36px;\r\n  height: 36px;\r\n  /* background-color: brown; */\r\n}\r\n\r\n#recruiter-dialog .recruiter-queue-item-delete-btn {\r\n  margin-left: 4px;\r\n  border: 1px solid red;\r\n  color: red;\r\n  width: 18px;\r\n  height: 18px;\r\n  cursor: pointer;\r\n  transition-duration: 0.2s;\r\n}\r\n\r\n#recruiter-dialog .recruiter-queue-item-delete-btn:hover {\r\n  background-color: red;\r\n  color: white;\r\n}\r\n\r\n.recruiter-queue-item-info {\r\n  font-size: 0.8rem;\r\n}\r\n\r\n#recruiter-dialog .recruiter-queue-item-number {}\r\n\r\n#recruiter-dialog .recruiter-buttons-section {\r\n  margin: 0 auto;\r\n}\r\n\r\n#recruiter-dialog #recruiter-cancel-btn {\r\n  border: 1px solid red;\r\n  color: red;\r\n  padding: 4px 8px;\r\n  cursor: pointer;\r\n}\r\n\r\n#recruiter-dialog #recruiter-add-btn {\r\n  border: 1px solid green;\r\n  color: green;\r\n  padding: 4px 8px;\r\n  cursor: pointer;\r\n}\r\n\r\n#recruiter-dialog #recruiter-confirm-btn {\r\n  /* border: 1px solid green; */\r\n  /* color: green; */\r\n  padding: 4px 8px;\r\n  cursor: pointer;\r\n  margin-left: 20px;\r\n}'},813:(e,t,n)=>{n.r(t),n.d(t,{default:()=>i});const i='<div style="margin-top: 8px;">\r\n  <input id="schedule-date" type="date" />\r\n  <input id="schedule-time" type="text" size="5" placeholder="hh:mm:ss" />\r\n  <button type="button" id="schedule-button">Schedule</button>\r\n  <p id="schedule-error" style="color: red;font-size: 0.8em; margin: 4px; padding: 0px; font-weight: bold; background-color: white;"></p>\r\n  <p id="schedule-info" style="color: green;font-size: 0.8em; margin: 4px; padding: 0px; font-weight: bold; background-color: white;"></p>\r\n</div>'},846:(e,t,n)=>{n.r(t),n.d(t,{default:()=>i});const i='<div id="table-container" class="hidden">\r\n  <table id="scheduler-lookup-table">\r\n    <thead>\r\n      <tr>\r\n        <th id="operation-type">Operation Type</th>\r\n        <th class="source-city">Source City</th>\r\n        <th class="destination-city">Destination City</th>\r\n        <th class="departure-time">Departure Time</th>\r\n        <th class="arrival-time">Arrival Time</th>\r\n        <th class="actions">\r\n          <div class="close-icon">\r\n            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="display: block;">\r\n              <line x1="1" y1="1" x2="23" y2="23"></line>\r\n              <line x1="23" y1="1" x2="1" y2="23"></line>\r\n            </svg>\r\n          </div>\r\n        </th>\r\n      </tr>\r\n    </thead>\r\n    <tbody>\r\n      <tr>\r\n        <td colspan="6" id="no-schedules">No schedules</td>\r\n      </tr>\r\n    </tbody>\r\n  </table>\r\n</div>\r\n<button id="scheduler-toggle-button">scheduler</button>'},218:(e,t,n)=>{n.r(t),n.d(t,{default:()=>i});const i="#table-container {\r\n  max-height: 50vh;\r\n  overflow-y: auto;\r\n  border: 1px solid #ddd;\r\n  width: fit-content;\r\n}\r\n\r\n#scheduler-lookup-table {\r\n  font-family: Arial, Helvetica, sans-serif;\r\n  border-collapse: collapse;\r\n  font-size: 18px;\r\n  text-align: left;\r\n  position: absolute;\r\n  top: 50%;\r\n  left: 50%;\r\n  transform: translate(-50%, -50%);\r\n  z-index: 2000 !important;\r\n  background-color: antiquewhite;\r\n}\r\n\r\n#no-schedules {\r\n  text-align: center;\r\n  height: 50px;\r\n}\r\n\r\n.attack {\r\n  font-weight: 600;\r\n  color: #d32f2f;\r\n}\r\n\r\n.support {\r\n  font-weight: 600;\r\n  color: #2979ff;\r\n}\r\n\r\n#scheduler-lookup-table * {\r\n  font-size: 14px;\r\n}\r\n\r\n#scheduler-lookup-table th,\r\n#scheduler-lookup-table td {\r\n  border: 1px solid #ddd;\r\n  padding: 8px;\r\n}\r\n\r\n#scheduler-lookup-table th {\r\n  background-color: #f2f2f2;\r\n  font-weight: bold;\r\n}\r\n\r\n#scheduler-lookup-table td {\r\n  text-wrap: nowrap;\r\n}\r\n\r\n\r\n.cancel-button {\r\n  background-color: #f44336;\r\n  color: white;\r\n  border: none;\r\n  padding: 5px 10px;\r\n  cursor: pointer;\r\n  transition-duration: 150ms;\r\n}\r\n\r\n.cancel-button:hover {\r\n  background-color: #d32f2f;\r\n}\r\n\r\n#scheduler-toggle-button {\r\n  padding: 4px 8px;\r\n  font-size: 12px;\r\n  font-variant: small-caps;\r\n  cursor: pointer;\r\n  border-radius: 20px;\r\n  position: absolute;\r\n  bottom: 98px;\r\n  left: 10px;\r\n  margin: 0;\r\n  z-index: 1000;\r\n  transition-duration: 150ms;\r\n}\r\n\r\n#scheduler-toggle-button:hover {\r\n  background-color: #ddd;\r\n}\r\n\r\n.actions {\r\n  min-width: 22px;\r\n}\r\n\r\n.close-icon {\r\n  position: absolute;\r\n  cursor: pointer;\r\n  right: 5px;\r\n  top: 5px;\r\n  color: #000;\r\n}\r\n\r\n.close-icon:hover {\r\n  scale: 1.1;\r\n  transition-duration: 150ms;\r\n}\r\n\r\n.hidden {\r\n  display: none;\r\n}"},773:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),t.FarmTimeInterval=void 0,function(e){e[e.FirstOption=3e5]="FirstOption",e[e.SecondOption=12e5]="SecondOption",e[e.ThirdOption=54e5]="ThirdOption",e[e.FourthOption=144e5]="FourthOption"}(n||(t.FarmTimeInterval=n={}));const i={resources:{minPopulationBuffer:100,storeAlmostFullPercentage:.9},farmConfig:{farmInterval:n.FirstOption,humanize:!1,farmingCities:[]},general:{timeDifference:11500,antyTimingMs:1e4,applicationRefreshInterval:192e4,forcedRefresh:!1,farm:!0,builder:!0,guard:!1,recruiter:!1},recruiter:{autoReevaluate:!0}};t.default=i},323:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function l(e){try{s(i.next(e))}catch(e){o(e)}}function a(e){try{s(i.throw(e))}catch(e){o(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(l,a)}s((i=i.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=r(n(707)),l=r(n(13)),a=r(n(7)),s=r(n(639)),c=n(773),u=r(n(2));class d extends a.default{constructor(){super(),this.uniquelySelectedFarmingCitiesPerIsle={},this.isFarmChecked=()=>this.farm,this.isBuilderChecked=()=>this.builder,this.isGuardChecked=()=>this.guard,this.isRecruiterChecked=()=>this.recruiter,this.getPlunderConfig=()=>{},this.emitRecruiterConfigChange=()=>{this.emit("recruiterAutoReevaluateChange")},this.getManagersFlags=()=>({farm:this.farm,builder:this.builder,guard:this.guard}),this.configManager=s.default.getInstance(),this.config=this.configManager.getConfig(),this.farm=this.config.general.farm,this.builder=this.config.general.builder,this.guard=this.config.general.guard,this.recruiter=this.config.general.recruiter,this.recruiterAutoReevaluate=this.config.recruiter.autoReevaluate,this.farmInterval=this.config.farmConfig.farmInterval,this.humanize=this.config.farmConfig.humanize}initEventListeners(){var e,t;const n=document.querySelector("#config-popup-container"),i=n.querySelector("#farm"),r=n.querySelector("#builder"),o=n.querySelector("#recruiter"),l=n.querySelector("#recruiter-auto-reevaluate"),a=n.querySelector("#guard"),s=n.querySelector("#time-interval-select"),u=n.querySelector(".show-trigger"),d=n.querySelector("#close-popup"),h=n.querySelector("#humanize-checkbox");if(!n)throw new Error('"#config-popup-container" couldn\'t be found.');d.addEventListener("click",(()=>{n.classList.contains("minimized")||n.classList.add("minimized")})),n.querySelectorAll("#button-panel button").forEach((e=>e.addEventListener("click",(()=>{"reset"===e.type&&(i.checked=!1,this.farm=!1,r.checked=!1,this.builder=!1,a.checked=!1,this.guard=!1,o.checked=!1,this.recruiter=!1);const t=Object.keys(this.uniquelySelectedFarmingCitiesPerIsle).some((e=>{var t;return this.uniquelySelectedFarmingCitiesPerIsle[e].name!==(null===(t=this.config.farmConfig.farmingCities.find((t=>t.isleId===e)))||void 0===t?void 0:t.name)}));console.log("conflictingCitiesChanged",t);const l={recruiter:{autoReevaluate:this.config.recruiter.autoReevaluate!==this.recruiterAutoReevaluate},farmConfig:{farmInterval:this.config.farmConfig.farmInterval!==this.farmInterval,humanize:this.config.farmConfig.humanize!==this.humanize,farmingCities:t},general:{farm:this.config.general.farm!==this.farm,builder:this.config.general.builder!==this.builder,guard:this.config.general.guard!==this.guard,recruiter:this.config.general.recruiter!==this.recruiter}};this.configChanged(l)&&(this.config.farmConfig.farmInterval=this.farmInterval,this.config.farmConfig.humanize=this.humanize,this.config.general.farm=this.farm,this.config.general.builder=this.builder,this.config.general.guard=this.guard,this.config.general.recruiter=this.recruiter,this.config.recruiter.autoReevaluate=this.recruiterAutoReevaluate,this.config.farmConfig.farmingCities=Object.values(this.uniquelySelectedFarmingCitiesPerIsle),this.configManager.persistConfig()),this.farmInterval===c.FarmTimeInterval.FourthOption&&(confirm("Farmienie ustawione na 4h/8h. Kliknij OK aby kontynuować lub Anuluj aby cofnąć (na 5min/10min).")||(this.farmInterval=c.FarmTimeInterval.FirstOption,s.value=c.FarmTimeInterval.FirstOption.toString())),n.classList.add("minimized"),this.emit("managersChange",l)})))),u.addEventListener("click",(()=>{n.classList.contains("minimized")&&n.classList.remove("minimized")})),i.addEventListener("change",(()=>{this.farm=i.checked})),r.addEventListener("change",(()=>{this.builder=r.checked})),a.addEventListener("change",(()=>{this.guard=a.checked})),o.addEventListener("change",(()=>{this.recruiter=o.checked})),s.addEventListener("change",(()=>{this.farmInterval=Number(s.value),console.log("this.farmInterval changed to: ",this.farmInterval)}));const m=null===(e=n.querySelector("#farm"))||void 0===e?void 0:e.parentElement,g=m.querySelector(".expandable-section"),f=m.querySelector(".arrow-down");f.addEventListener("click",(()=>{g.classList.toggle("hidden"),f.classList.toggle("rotate")})),h.addEventListener("change",(()=>{this.humanize=h.checked})),l.checked=this.recruiterAutoReevaluate;const p=null===(t=n.querySelector("#recruiter"))||void 0===t?void 0:t.parentElement,v=p.querySelector(".expandable-section"),y=p.querySelector(".arrow-down");y.addEventListener("click",(()=>{v.classList.toggle("hidden"),y.classList.toggle("rotate")})),l.addEventListener("change",(()=>{this.recruiterAutoReevaluate=l.checked}))}createInitialElements(){return i(this,void 0,void 0,(function*(){var e;const t=document.createElement("div");t.innerHTML=l.default,t.querySelector("#farm").checked=this.farm,t.querySelector("#builder").checked=this.builder,t.querySelector("#guard").checked=this.guard,t.querySelector("#recruiter").checked=this.recruiter;const n=t.querySelector("#time-interval-select"),i=Object.values(c.FarmTimeInterval);return i.slice(i.length/2).forEach((e=>{const t=document.createElement("option");t.value=e.toString(),t.textContent=this.mapTimeIntervalKeyToText(e),n.appendChild(t)})),t.querySelector("#time-interval-select").value=null!==(e=this.config.farmConfig.farmInterval.toString())&&void 0!==e?e:c.FarmTimeInterval.FirstOption.toString(),t.querySelector("#humanize-checkbox").checked=this.config.farmConfig.humanize,yield this.createConfictingCitiesSelects(t),t}))}createConfictingCitiesSelects(e){return i(this,void 0,void 0,(function*(){var t;const n=(yield u.default.getInstance()).getCityList(),i=Array.from(new Set(n.map((e=>e.isleId)))).map((e=>n.filter((t=>t.isleId===e)))),r=i.some((e=>e.length>1)),o=e.querySelector("#conflicting-cities-container"),l=o.querySelector(".arrow-down"),a=o.querySelector(".section-content");if(r){o.classList.remove("hidden");for(const e of i){if(1===e.length){this.uniquelySelectedFarmingCitiesPerIsle[e[0].isleId]=e[0];continue}const n=null!==(t=e.find((t=>{var n;return t.name===(null===(n=this.config.farmConfig.farmingCities.find((t=>t.isleId===e[0].isleId)))||void 0===n?void 0:n.name)})))&&void 0!==t?t:e[0];this.uniquelySelectedFarmingCitiesPerIsle[e[0].isleId]=n;const i=document.createElement("div");i.className="isle-container";const r=document.createElement("div");r.className="isle-header",r.textContent=`Isle ${e[0].isleId}`,i.appendChild(r);const o=document.createElement("select");o.name=`isle-${e[0].isleId}-cities`,o.id=`isle-${e[0].isleId}-cities`,i.appendChild(o),e.forEach((e=>{const t=document.createElement("option");t.value=e.name,t.textContent=e.name,o.appendChild(t)})),o.value=n.name,o.addEventListener("change",(()=>{const t=e.find((e=>e.name===o.value));t&&(this.uniquelySelectedFarmingCitiesPerIsle[e[0].isleId]=t,console.log("this.conflictingCities",this.uniquelySelectedFarmingCitiesPerIsle))})),a.appendChild(i)}}else o.classList.add("hidden"),this.uniquelySelectedFarmingCitiesPerIsle=n.reduce(((e,t)=>(e[t.isleId]=t,e)),{});l.addEventListener("click",(()=>{a.classList.toggle("hidden"),l.classList.toggle("rotate")}))}))}mapTimeIntervalKeyToText(e){switch(e){case c.FarmTimeInterval.FirstOption:return"5m/10m";case c.FarmTimeInterval.SecondOption:return"20m/40m";case c.FarmTimeInterval.ThirdOption:return"1h 30m/3h";case c.FarmTimeInterval.FourthOption:return"4h/8h";default:return"Unknown interval"}}addStyle(){const e=document.createElement("style");e.textContent=o.default,document.head.appendChild(e)}render(){return i(this,void 0,void 0,(function*(){this.addStyle();const e=yield this.createInitialElements();document.body.appendChild(e),this.initEventListeners()}))}configChanged(e){for(const[t,n]of Object.entries(e))if("object"==typeof n){if(this.configChanged(n))return!0}else if(n)return!0;return!1}minimize(){const e=document.querySelector("#config-popup-container");null==e||e.classList.add("minimized")}}t.default=d},927:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function l(e){try{s(i.next(e))}catch(e){o(e)}}function a(e){try{s(i.throw(e))}catch(e){o(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(l,a)}s((i=i.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=r(n(299)),l=n(910);(0,n(396).onPageLoad)((()=>i(void 0,void 0,void 0,(function*(){console.log("VERY POLITE GPS v.0.5.0 MVP walikonie special edition (c) 2024");const e=window.location.href;/.*grepolis.com\/game\/.*/.test(e)?yield o.default.getInstance():e.includes("start?nosession")&&(console.log("will try to reconnect in 5 minutes"),setInterval((()=>{var e;(0,l.setCookie)("forceRestart",!0),null===(e=document.querySelector(".world_name.end_game_type_world_wonder"))||void 0===e||e.click()}),3e5))}))))},641:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0});class n{constructor(){this.callback=null}static getInstance(){return n.instance||(n.instance=new n,n.instance.mountObserver()),n.instance}mountObserver(){const e=new MutationObserver((e=>{e.forEach((e=>{if("childList"===e.type)for(const t of e.addedNodes)if(t instanceof HTMLElement&&"unit_movements"===t.getAttribute("data-commandtype")&&"-1"!=t.getAttribute("data-cancelable")&&this.callback)return this.callback(t.id),void(this.callback=null)}))})),t=document.querySelector("#toolbar_activity_commands_list .content.js-dropdown-item-list");e.observe(t,{childList:!0,subtree:!1})}setCallback(e){this.callback=e}}t.default=n},147:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function l(e){try{s(i.next(e))}catch(e){o(e)}}function a(e){try{s(i.throw(e))}catch(e){o(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(l,a)}s((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.buildings=t.buildingsSelectors=void 0;const r=n(396),o=e=>i(void 0,void 0,void 0,(function*(){const t=document.querySelector('[name="city_overview"]');(null==t?void 0:t.classList.contains("checked"))||null==t||t.click();const n=document.querySelector('[class="construction_queue_build_button"] div');n.classList.contains("active")||n.click(),yield(0,r.waitForElement)(e).then((e=>e.click()))}));t.buildingsSelectors={buildButton:".btn_build.build_button",currentLvl:'[class="twa_content js-content-area"] span:nth-of-type(3)',disabled:"disabled"},t.buildings={main:{backgroundImageProp:"url(https://gpen.innogamescdn.com/images/game/main/main.png)",elementSelector:".city_overview_overlay.main",currentLvlElSelector:'.city_overview_overlay.main [class="twa_content js-content-area"] span:nth-of-type(3)',name:"Senate",buildAction:()=>o(".city_overview_overlay.main .btn_build.build_button")},hide:{backgroundImageProp:"url(https://gpen.innogamescdn.com/images/game/main/hide.png)",elementSelector:".city_overview_overlay.hide",currentLvlElSelector:'.city_overview_overlay.hide [class="twa_content js-content-area"] span:nth-of-type(3)',name:"Cave",buildAction:()=>o(".city_overview_overlay.hide .btn_build.build_button")},lumber:{backgroundImageProp:"url(https://gpen.innogamescdn.com/images/game/main/lumber.png)",elementSelector:".city_overview_overlay.lumber",currentLvlElSelector:'.city_overview_overlay.lumber [class="twa_content js-content-area"] span:nth-of-type(3)',name:"Lumber mill",buildAction:()=>o(".city_overview_overlay.lumber .btn_build.build_button")},stoner:{backgroundImageProp:"url(https://gpen.innogamescdn.com/images/game/main/stoner.png)",elementSelector:".city_overview_overlay.stoner",currentLvlElSelector:'.city_overview_overlay.stoner [class="twa_content js-content-area"] span:nth-of-type(3)',name:"Quarry",buildAction:()=>o(".city_overview_overlay.stoner .btn_build.build_button")},ironer:{backgroundImageProp:"url(https://gpen.innogamescdn.com/images/game/main/ironer.png)",elementSelector:".city_overview_overlay.ironer",currentLvlElSelector:'.city_overview_overlay.ironer [class="twa_content js-content-area"] span:nth-of-type(3)',name:"Silver mine",buildAction:()=>o(".city_overview_overlay.ironer .btn_build.build_button")},market:{backgroundImageProp:"url(https://gpen.innogamescdn.com/images/game/main/market.png)",elementSelector:".city_overview_overlay.market",currentLvlElSelector:'.city_overview_overlay.market [class="twa_content js-content-area"] span:nth-of-type(3)',name:"Market",buildAction:()=>o(".city_overview_overlay.market .btn_build.build_button")},docks:{backgroundImageProp:"url(https://gpen.innogamescdn.com/images/game/main/docks.png)",elementSelector:".city_overview_overlay.docks",currentLvlElSelector:'.city_overview_overlay.docks [class="twa_content js-content-area"] span:nth-of-type(3)',name:"Harbor",buildAction:()=>o(".city_overview_overlay.docks .btn_build.build_button")},barracks:{backgroundImageProp:"url(https://gpen.innogamescdn.com/images/game/main/barracks.png)",elementSelector:".city_overview_overlay.barracks",currentLvlElSelector:'.city_overview_overlay.barracks [class="twa_content js-content-area"] span:nth-of-type(3)',name:"Barracks",buildAction:()=>o(".city_overview_overlay.barracks .btn_build.build_button")},wall:{backgroundImageProp:"url(https://gpen.innogamescdn.com/images/game/main/wall.png)",elementSelector:".city_overview_overlay.wall",currentLvlElSelector:'.city_overview_overlay.wall [class="twa_content js-content-area"] span:nth-of-type(3)',name:"City wall",buildAction:()=>o(".city_overview_overlay.wall .btn_build.build_button")},storage:{backgroundImageProp:"url(https://gpen.innogamescdn.com/images/game/main/storage.png)",elementSelector:".city_overview_overlay.storage",currentLvlElSelector:'.city_overview_overlay.storage [class="twa_content js-content-area"] span:nth-of-type(3)',name:"Warehouse",buildAction:()=>o(".city_overview_overlay.storage .btn_build.build_button")},farm:{backgroundImageProp:"url(https://gpen.innogamescdn.com/images/game/main/farm.png)",elementSelector:".city_overview_overlay.farm",currentLvlElSelector:'.city_overview_overlay.farm [class="twa_content js-content-area"] span:nth-of-type(3)',name:"Farm",buildAction:()=>o(".city_overview_overlay.farm .btn_build.build_button")},academy:{backgroundImageProp:"url(https://gpen.innogamescdn.com/images/game/main/academy.png)",elementSelector:".city_overview_overlay.academy",currentLvlElSelector:'.city_overview_overlay.academy [class="twa_content js-content-area"] span:nth-of-type(3)',name:"Academy",buildAction:()=>o(".city_overview_overlay.academy .btn_build.build_button")},temple:{backgroundImageProp:"url(https://gpen.innogamescdn.com/images/game/main/temple.png)",elementSelector:".city_overview_overlay.temple",currentLvlElSelector:'.city_overview_overlay.temple [class="twa_content js-content-area"] span:nth-of-type(3)',name:"Temple",buildAction:()=>o(".city_overview_overlay.temple .btn_build.build_button")}}},233:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function l(e){try{s(i.next(e))}catch(e){o(e)}}function a(e){try{s(i.throw(e))}catch(e){o(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(l,a)}s((i=i.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(910),l=r(n(785)),a=n(396),s=r(n(77)),c=r(n(165)),u=n(147),d=r(n(254)),h=r(n(2)),m=r(n(715));class g{constructor(){this.allowUnsequentialBuilds=!1,this.allowCriticalBuilds=!0,this.RUN=!1,this.mainQueue=[]}static getInstance(){return i(this,void 0,void 0,(function*(){return g.instance||(g.instance=new g,g.instance.lock=l.default.getInstance(),g.instance.resourceManager=yield d.default.getInstance(),g.instance.citySwitchManager=yield h.default.getInstance(),g.instance.generalInfo=m.default.getInstance(),g.instance.addStyle(),g.instance.renderUI(),g.instance.loadQueueFromStorage(),g.instance.listenToCitySwitch()),g.instance}))}renderUI(){const e=document.createElement("div");e.innerHTML=c.default,document.body.appendChild(e),this.addBuildButtons(),this.initToggleButtonEvents()}initToggleButtonEvents(){document.getElementById(g.toggleBuilderButtonId).addEventListener("click",(()=>{const e=document.getElementById(g.buildContainerId);e.classList.toggle("hidden"),e.classList.contains("hidden")?this.tryExitBuildMode():this.tryGoToBuildMode("current")}))}listenToCitySwitch(){this.citySwitchManager.on("cityChange",(e=>{const t=this.mainQueue.find((t=>t.city===e));this.rerenderQueue(t)}))}getBuilderScheduleTimes(){return this.mainQueue.map((e=>e.scheduledDate))}addBuildButtons(){const e=document.getElementById(g.buildOptionsContainerId);Object.values(u.buildings).forEach((t=>{const n=document.createElement("div");n.className=g.buildOptionItemClass,n.style.backgroundImage=t.backgroundImageProp,e.appendChild(n);const i=document.createElement("div");i.className=g.buildOptionItemAddClass,i.innerHTML="+",n.appendChild(i),n.addEventListener("click",(()=>{this.onOptionBuildButtonClick(t)}))}))}tryGoToBuildMode(e){return i(this,void 0,void 0,(function*(){var t;"current"!==e&&(yield e.switchAction()),null===(t=document.querySelector('[name="city_overview"]'))||void 0===t||t.click();const n=yield(0,a.waitForElement)('[class="construction_queue_build_button"] div',2e3);n.classList.contains("active")||n.click()}))}tryExitBuildMode(){const e=document.querySelector('[class="construction_queue_build_button"] div');(null==e?void 0:e.classList.contains("active"))&&e.click()}onOptionBuildButtonClick(e){const t=this.citySwitchManager.getCurrentCity();let n=this.mainQueue.find((e=>e.city.name===t.name));n||(n={city:t,queue:[],schedule:null,scheduledDate:null},this.mainQueue.push(n)),this.addToQueue(e,n)}addBuldingToUIQueue(e,t="end",n){const i=document.getElementById("additional-queue"),r=document.createElement("div");r.className=g.queueItemClass,r.style.backgroundImage=e.building.backgroundImageProp,r.setAttribute("data-id",e.id),"start"===t?this.appendChildAtIndex(i,r,0):i.appendChild(r);const o=document.createElement("div");o.className=g.upButtonClass,o.textContent=`+${e.toLvl}`,r.appendChild(o);const l=document.createElement("div");return l.className=g.cancelButtonClass,l.innerHTML="&#x2715;",r.appendChild(l),l.addEventListener("click",(()=>{const t=n.queue.findIndex((t=>t.id===e.id));-1!==t?(0===t?(n.queue.shift(),n.schedule&&(clearInterval(n.schedule),clearTimeout(n.schedule),n.schedule=null,n.scheduledDate=null),this.revalidateQueueItemLevels(e.building,t,n),this.handleBuildSchedule(n)):(n.queue.splice(t,1),this.revalidateQueueItemLevels(e.building,t,n)),r.remove(),this.saveQueueToStorage()):console.log("Item not found in queue")})),console.log("queueItemEl",r),r}revalidateQueueItemLevels(e,t,n){console.log("--------revalidateQueueItemLevels",e,t),n.queue.filter(((n,i)=>i>=t&&n.building.name===e.name)).forEach((e=>{const t=e.toLvl-1,n=`${e.building.name}-${t}`,i=document.querySelector(`[data-id="${e.id}"]`);i&&(i.querySelector(".up").textContent=`+${t}`,i.setAttribute("data-id",n)),e.toLvl=t,e.id=n}))}addToQueue(e,t){return i(this,void 0,void 0,(function*(){let n;if(yield this.tryGoToBuildMode("current"),yield(0,a.waitForElement)(e.elementSelector,1e3).catch((()=>null))){const t=yield(0,a.waitForElement)(`${e.elementSelector} ${u.buildingsSelectors.currentLvl}`,1e3).then((e=>e.textContent)).catch((()=>null));n="max"!==t||null!==t?Number(t):1/0}else n=0;if(n===1/0)return;const i=t.queue.filter((t=>t.building.name===e.name)).length+1,r={id:`${e.name}-${n+i}`,building:e,toLvl:n+i};console.log("queueItem",r),this.addBuldingToUIQueue(r,"end",t),t.queue.push(r),this.saveQueueToStorage(),console.log("pushed to queue:",JSON.parse(JSON.stringify(t.queue))),this.buildOrSchedule(t)}))}buildOrSchedule(e){return i(this,void 0,void 0,(function*(){1===e.queue.length?(console.log("\t-queue has only one item, handling immediately"),e.schedule&&(clearInterval(e.schedule),clearTimeout(e.schedule),e.schedule=null,e.scheduledDate=null),yield this.handleBuildSchedule(e)):console.log("\t-queue has more than one item, waiting for its turn")}))}performBuildSchedule(e){return i(this,void 0,void 0,(function*(){if(e&&e.queue.length)if(console.log("performBuildSchedule with queue:",JSON.parse(JSON.stringify(e.queue))),yield this.isEmptySlot(e.city)){console.log("\t-isEmptySlot is true, checking if can build");const t=e.queue[0];yield this.checkIfItemCanBeBuiltAndAddDeleteOrSchedule(e,t)}else console.log("\t-isEmptySlot is false, scheduling speed up"),yield this.setTimeoutForNextSpeedUpAndSchedule(e);else(yield this.isQueueEmpty(e.city))||(yield this.setTimeoutForNextSpeedUpAndSchedule(e))}))}setTimeoutForNextSpeedUpAndSchedule(e){return i(this,void 0,void 0,(function*(){console.log("setTimeoutForNextSpeedUpAndSchedule execution()");const t=yield this.getTimeToCanSpeedUp(e.city).catch((()=>null));console.log("\t-timeToSpeedUp:",t),null===t?(console.log("\t-timeToSpeedUp is null, performing build schedule to reevaluate conditions"),yield this.performBuildSchedule(e)):t<=0?(console.log("\t-will speed up first build immediately"),yield this.speedUpFirstBuild(e.city),console.log("\t-call performBuildSchedule for the waiting item"),yield this.performBuildSchedule(e)):(console.log("\t-time to speed up is:",t,"will be scheduled at:",(0,o.getTimeInFuture)(t)),e.schedule=setTimeout((()=>i(this,void 0,void 0,(function*(){try{yield this.lock.acquire({method:e.city.name+" - setTimeoutForNextSpeedUpAndSchedule (inside timeout)",manager:"builder"}),console.log("setTimeoutForNextSpeedUpAndSchedule() inside timeout"),console.log("\t-speed up first build"),yield this.speedUpFirstBuild(e.city),console.log("\t-performBuildSchedule"),yield this.performBuildSchedule(e)}catch(t){console.warn("CityBuilder.setTimeoutForNextSpeedUpAndSchedule().catch",t),console.log("\t-retrying by calling handleBuildSchedule()"),e.schedule=null,e.scheduledDate=null,this.handleBuildSchedule(e)}finally{e.description=void 0,e.operation=void 0,console.log("mainQueue:",JSON.parse(JSON.stringify(this.mainQueue))),this.lock.release()}}))),t+2e3),e.scheduledDate=new Date(Date.now()+t),e.description="Waiting for speed up",e.operation="speedUp",console.log("mainQueue:",JSON.parse(JSON.stringify(this.mainQueue))))}))}checkIfItemCanBeBuiltAndAddDeleteOrSchedule(e,t){return i(this,arguments,void 0,(function*(e,t,n=!1){const i=t.building;console.log("check if can build item:",t);const r=yield this.canBuild(i,e.city);if(console.log("\t-canBuild:",r),!0===r){console.log("\t-canBuild is true, building...");const n=this.getEmptySlotsCount();yield i.buildAction(),yield this.untilEmptyslotsAreEqual(n-1),yield this.shiftQueueCleanScheduleAndTryNext(t,e)}else if("maxed"===r)console.log("\t-canBuild is maxed or not possible at the moment, shifting queue"),n?(this.clearUIQueueItem(e.queue[1]),e.queue.splice(1,1),yield this.shiftQueueCleanScheduleAndTryNext(t,e)):yield this.shiftQueueCleanScheduleAndTryNext(t,e);else if("impossible"===r)(yield this.isQueueEmpty(e.city))?(console.log("\t-canBuild is impossible, and queue is empty, element must be deleted"),yield this.shiftQueueCleanScheduleAndTryNext(t,e)):(console.log("\t-canBuild is impossible, but queue is not empty, scheduling build because maybe after that it will be possible"),yield this.setTimeoutForNextSpeedUpAndSchedule(e));else{const n=yield this.areResourcesStackable(i,e.city);if(!0===n.areStackable)console.log("\t-areResourcesStackable is true, scheduling build"),yield this.handleResourcesStackableFlow(i,e,n.requiredResources,t);else if("population"===n.areStackable&&this.allowCriticalBuilds){console.log("\t\t-areResourcesStackable is population, adding farm to queue");const t=u.buildings.farm,n=yield this.getBuildingCurrentLvl(t),r={id:`${t.name}-${n}`,building:i,toLvl:n+1};e.queue.unshift(r),this.addBuldingToUIQueue(r,"start",e),yield this.performBuildSchedule(e)}else if("storage"===n.areStackable&&this.allowCriticalBuilds){console.log("\t\t-areResourcesStackable is storage, adding storage to queue");const t=u.buildings.storage,n=yield this.getBuildingCurrentLvl(t),r={id:`${t.name}-${n}`,building:i,toLvl:n+1};e.queue.unshift(r),this.addBuldingToUIQueue(r,"start",e),yield this.performBuildSchedule(e)}else"alreadyStacked"!==n.areStackable||(yield this.isQueueEmpty(e.city))?(console.log("Item cannot be scheduled, because it has not met requirements"),yield this.shiftQueueCleanScheduleAndTryNext(t,e)):(console.log("\t\t-areResourcesStackable is alreadyStacked, scheduling build"),yield this.setTimeoutForNextSpeedUpAndSchedule(e))}}))}handleResourcesStackableFlow(e,t,n,r){return i(this,void 0,void 0,(function*(){const o=()=>i(this,void 0,void 0,(function*(){return yield this.resourceManager.hasEnoughResources(n,t.city)})),l=()=>i(this,void 0,void 0,(function*(){if(!0===(yield this.canBuild(e,t.city))){const n=this.getEmptySlotsCount();yield e.buildAction(),yield this.untilEmptyslotsAreEqual(n-1),yield this.shiftQueueCleanScheduleAndTryNext(r,t)}else yield this.shiftQueueCleanScheduleAndTryNext(r,t)})),a=(yield this.isQueueEmpty(t.city))?null:yield this.getTimeToCanSpeedUp(t.city).catch((()=>null));if(!a)return t.schedule=setInterval((()=>i(this,void 0,void 0,(function*(){try{t.scheduledDate=new Date(Date.now()+g.BUILD_RETRY_INTERVAL),yield this.lock.acquire({method:t.city.name+" - checkIfItemCanBeBuiltAndAddDeleteOrSchedule (inside interval)",manager:"builder"}),(yield o())&&(yield l())}catch(e){console.warn("CityBuilder.handleResourcesStackable().catch",e)}finally{this.lock.release()}}))),g.BUILD_RETRY_INTERVAL),void(t.scheduledDate=new Date(Date.now()+g.BUILD_RETRY_INTERVAL));a<g.BUILD_RETRY_INTERVAL?(t.schedule=setTimeout((()=>i(this,void 0,void 0,(function*(){try{yield this.lock.acquire({method:t.city.name+" - handleResourcesStackable (inside checking timeout)",manager:"builder"}),yield this.speedUpFirstBuild(t.city),(yield o())?yield l():yield this.handleResourcesStackableFlow(e,t,n,r)}catch(e){console.warn("CityBuilder.handleResourcesStackable().catch",e)}finally{t.description=void 0,t.operation=void 0,console.log("mainQueue:",JSON.parse(JSON.stringify(this.mainQueue))),this.lock.release()}}))),a),t.scheduledDate=new Date(Date.now()+a),t.description="Speeding up first build, then checking if can build, else comparing times for next schedule",t.operation="speedUpAndCheck",console.log("mainQueue:",JSON.parse(JSON.stringify(this.mainQueue)))):(t.schedule=setTimeout((()=>i(this,void 0,void 0,(function*(){try{yield this.lock.acquire({method:t.city.name+" - handleResourcesStackable (inside checking timeout)",manager:"builder"}),(yield o())?yield l():yield this.handleResourcesStackableFlow(e,t,n,r)}catch(e){console.warn("CityBuilder.handleResourcesStackable().catch",e)}finally{t.description=void 0,t.operation=void 0,console.log("mainQueue:",JSON.parse(JSON.stringify(this.mainQueue))),this.lock.release()}}))),g.BUILD_RETRY_INTERVAL),t.scheduledDate=new Date(Date.now()+g.BUILD_RETRY_INTERVAL),t.description="Checking if can build, then checking if next speed up time is shorter than standard interval",t.operation="buildCheck",console.log("mainQueue:",JSON.parse(JSON.stringify(this.mainQueue))))}))}getBuildingCurrentLvl(e){return i(this,void 0,void 0,(function*(){const t=(yield(0,a.waitForElement)(`${e.elementSelector} ${u.buildingsSelectors.currentLvl}`)).textContent;return"max"!==t?Number(t):1/0}))}clearUIQueueItem(e){const t=document.querySelector(`[data-id="${e.id}"]`);t&&t.remove()}getEmptySlotsCount(){return document.querySelectorAll(".construction_queue_order_container.instant_buy .js-queue-item.empty_slot").length}untilEmptyslotsAreEqual(e){return i(this,void 0,void 0,(function*(){return new Promise((t=>{const n=setInterval((()=>{this.getEmptySlotsCount()===e&&(console.log("\t-emptyslotsAreEqual:",e),clearInterval(n),t())}),333)}))}))}shiftQueueCleanScheduleAndTryNext(e,t){return i(this,void 0,void 0,(function*(){t.queue.shift(),this.saveQueueToStorage(),t.schedule&&(clearInterval(t.schedule),clearTimeout(t.schedule),t.schedule=null,t.scheduledDate=null),this.clearUIQueueItem(e),yield this.performBuildSchedule(t)}))}goToCityView(){const e=document.querySelector('[name="city_overview"]');null==e||e.click()}handleBuildSchedule(e){return i(this,void 0,void 0,(function*(){try{yield this.lock.acquire({method:e.city.name+" - handleBuildSchedule",manager:"builder"}),this.generalInfo.showInfo("Builder:",`Obsługa kolejki w mieście: ${e.city.name}`),yield this.performBuildSchedule(e)}catch(e){console.warn("CityBuilder.doQueueOperation().catch",e)}finally{console.log("handleBuildSchedule, release lock",e.city.name),this.generalInfo.hideInfo(),this.lock.release()}}))}speedUpFirstBuild(e){return i(this,void 0,void 0,(function*(){yield this.tryGoToBuildMode(e);const t=yield(0,a.waitForElementInterval)('[data-order_index="0"] .type_free',{retries:5,interval:400}).catch((()=>null));if(!t)throw new Error("No free button found");{const e=this.getEmptySlotsCount();t.click(),yield this.untilEmptyslotsAreEqual(e+1)}}))}canBuild(e,t){return i(this,void 0,void 0,(function*(){if(yield this.tryGoToBuildMode(t),!(yield(0,a.waitForElement)(e.elementSelector,2e3).catch((()=>null))))return"impossible";const n=yield(0,a.waitForElement)(`${e.elementSelector} ${u.buildingsSelectors.buildButton}`,1e3).catch((()=>null));return n?!n.classList.contains(u.buildingsSelectors.disabled):"maxed"}))}areResourcesStackable(e,t){return i(this,void 0,void 0,(function*(){console.log("areResourcesStackable"),yield this.tryGoToBuildMode(t);let n=0;do{(0,a.triggerHover)(document.querySelector(`${e.elementSelector} ${u.buildingsSelectors.buildButton}`)),yield(0,o.addDelay)(333),n++}while(!(yield(0,a.waitForElement)('#popup_div img[src*="images/game/res/wood.png"]',500).catch((()=>!1)))&&n<4);if(4===n)return console.warn("No popup content found, had to try 4 times. Returning false"),{areStackable:!1,requiredResources:{wood:0,stone:0,iron:0}};const i=Number((yield(0,a.waitForElement)('#popup_div img[src*="images/game/res/wood.png"]',3e3)).nextSibling.textContent),r=Number((yield(0,a.waitForElement)('#popup_div img[src*="images/game/res/stone.png"]',0)).nextSibling.textContent),l=Number((yield(0,a.waitForElement)('#popup_div img[src*="images/game/res/iron.png"]',0)).nextSibling.textContent),s=Number((yield(0,a.waitForElement)('#popup_div img[src*="images/game/res/pop.png"]',0)).nextSibling.textContent);(0,a.cancelHover)(document.querySelector(`${e.elementSelector} ${u.buildingsSelectors.buildButton}`));const c=yield this.resourceManager.getResourcesInfo();console.log(`Resource requirements:\n      \t- Required population: ${s}\n      \t- Current population: ${this.resourceManager.getPopulation()}\n      \t- Store capacity: ${yield this.resourceManager.getStoreCapacity()}\n      \t- Required wood: ${i}\n      \t- Required stone: ${r}\n      \t- Required iron: ${l}`),console.log("Current resources:",c);const d={wood:i,stone:r,iron:l};return s>c.population.amount?(yield this.isBuildingInRealQueue(e))?{areStackable:"waiting",requiredResources:d}:{areStackable:"population",requiredResources:d}:[i,r,l].reduce(((e,t)=>t>e?t:e),0)>c.storeMaxSize?(yield this.isBuildingInRealQueue(e))?{areStackable:"waiting",requiredResources:d}:{areStackable:"storage",requiredResources:d}:i<=c.wood.amount&&r<=c.stone.amount&&l<=c.iron.amount&&s<=c.population.amount?{areStackable:"alreadyStacked",requiredResources:d}:{areStackable:!0,requiredResources:d}}))}addStyle(){const e=document.createElement("style");e.textContent=s.default,document.head.appendChild(e)}isBuildingInRealQueue(e,t){return i(this,void 0,void 0,(function*(){t&&(yield t.switchAction());const n=e.elementSelector.split(".")[2];for(const e of document.querySelectorAll(".type_building_queue .queued_building_order"))if(e.classList.contains(n))return!0;return!1}))}isEmptySlot(e){return i(this,void 0,void 0,(function*(){return this.goToCityView(),yield e.switchAction(),yield(0,o.addDelay)(1e3),yield(0,a.waitForElement)(".construction_queue_order_container.instant_buy .js-queue-item.empty_slot",1e3).then((()=>!0)).catch((()=>!1))}))}getTimeToCanSpeedUp(e){return i(this,void 0,void 0,(function*(){this.goToCityView(),yield e.switchAction(),yield(0,o.addDelay)(1e3);const t=yield(0,a.waitForElementInterval)('[data-order_index="0"] .countdown.js-item-countdown',{retries:5,interval:400}).catch((()=>null));if(t){const e=(0,o.textToMs)(t.textContent)-3e5;return console.log("getTimeToCanSpeedUp(): calculated time to speed up first order:",e),e}throw console.warn("getTimeToCanSpeedUp(): no item in the queue, throwing error"),new Error("No item in the queue.")}))}loadQueueFromStorage(){this.mainQueue=this.citySwitchManager.getCityList().map((e=>({city:e,queue:[],schedule:null,scheduledDate:null})));const e=localStorage.getItem("cityBuilderQueue");e&&JSON.parse(e).forEach((e=>{const t=this.citySwitchManager.getCityByName(e.city.name);if(!t)return;const n=e.queue.map((e=>{const t=Object.values(u.buildings).find((t=>t.name===e.building.name));return Object.assign(Object.assign({},e),{building:t})}));this.mainQueue.find((e=>e.city===t)).queue=n}));const t=this.citySwitchManager.getCurrentCity(),n=this.mainQueue.find((e=>e.city===t));n&&n.queue.forEach((e=>{this.addBuldingToUIQueue(e,"end",n)}))}saveQueueToStorage(){localStorage.setItem("cityBuilderQueue",JSON.stringify(this.mainQueue))}isQueueEmpty(e){return i(this,void 0,void 0,(function*(){return yield e.switchAction(),this.goToCityView(),new Promise((e=>setTimeout((()=>null!=e(document.querySelector(".empty_queue"))),0)))}))}start(){return i(this,void 0,void 0,(function*(){this.RUN=!0,document.getElementById(g.toggleBuilderButtonId).classList.remove("hidden");for(const e of this.mainQueue)yield this.handleBuildSchedule(e)}))}stop(){console.log("Stopping"),this.RUN=!1,this.mainQueue.forEach((e=>{e.schedule&&(clearInterval(e.schedule),clearTimeout(e.schedule),e.schedule=null,e.scheduledDate=null)})),document.getElementById(g.toggleBuilderButtonId).classList.add("hidden")}isRunning(){return this.RUN}appendChildAtIndex(e,t,n){e.insertBefore(t,e.children[n])}rerenderQueue(e){document.getElementById("additional-queue").innerHTML="",e&&e.queue.forEach((t=>{this.addBuldingToUIQueue(t,"end",e)}))}}g.queueContainerId="additional-queue",g.queueItemClass="queue-item",g.cancelButtonClass="cancel",g.upButtonClass="up",g.buildOptionsContainerId="build-options",g.buildOptionItemClass="build-option",g.buildOptionItemAddClass="build-options-add",g.buildContainerId="build-container",g.toggleBuilderButtonId="toggle-builder",g.BUILD_RETRY_INTERVAL=6e5,t.default=g},2:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function l(e){try{s(i.next(e))}catch(e){o(e)}}function a(e){try{s(i.throw(e))}catch(e){o(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(l,a)}s((i=i.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=r(n(7)),l=n(396),a=n(910),s=r(n(715));class c extends o.default{constructor(){super(),this.RUN=!1,this.cityList=[],this.switchActionForCity=e=>(...t)=>i(this,[...t],void 0,(function*(t=!0){try{if(document.querySelector("div.town_name").textContent!==e){let t=document.querySelector(".group_towns");if(!t)do{yield(0,l.waitForElement)(".town_groups_dropdown.btn_toggle_town_groups_menu",1e3).then((e=>e.click())).catch((()=>null)),yield(0,a.addDelay)(333)}while(!(t=yield(0,l.waitForElement)(".group_towns",1500).catch((()=>null))));Array.from(t.querySelectorAll("span.town_name")).find((t=>t.textContent===e)).click();do{yield(0,a.addDelay)(100)}while(document.querySelector("div.town_name").textContent!==e)}t&&document.querySelector(".btn_jump_to_town.circle_button.jump_to_town").click(),yield(0,a.addDelay)(100)}catch(e){console.warn("switchAction.catch:",e)}}))}static getInstance(){return i(this,void 0,void 0,(function*(){return c.instance||(c.instance=new c,c.instance.generalInfo=s.default.getInstance(),c.instance.cityList=yield c.instance.initCityList(),c.instance.mountObserver()),c.instance}))}mountObserver(){new MutationObserver((e=>{for(const t of e)t.addedNodes.length&&(this.emit("cityChange",this.getCurrentCity()),console.log("cityChange:",this.getCurrentCity()))})).observe(document.querySelector(".town_name_area .town_name.js-rename-caption"),{childList:!0})}initCityList(){return i(this,void 0,void 0,(function*(){var e,t,n,i,r;let o;for(this.generalInfo.showInfo("City Switch Manager:","Inicjalizacja listy miast"),(yield(0,l.waitForElement)(".town_groups_dropdown.btn_toggle_town_groups_menu")).click();!(o=yield(0,l.waitForElement)(".group_towns",1e3).catch((()=>null)));)document.querySelector(".btn_toggle_town_groups_menu").click(),yield(0,a.addDelay)(100);const s=o.querySelectorAll("span.town_name"),u=Array.from(s).map((e=>({name:e.textContent,cityId:e.parentElement.getAttribute("data-townid")}))),d=localStorage.getItem(c.LOCAL_STORAGE_CITY_LIST_KEY);if(d){const e=JSON.parse(d);if(e.length!==s.length);else{let t=!0;for(const n of e)if(!u.find((e=>e.name===n.name&&e.cityId===n.cityId))){t=!1;break}if(t)return this.generalInfo.hideInfo(),this.hydrateCityList(e)}}const h=[];for(const o of s){console.log("initCityList.town:",o);const s=o.parentElement.getAttribute("data-townid");console.log("\t-cityId:",s),yield this.openTownList(),console.log("\t-openTownList");for(const e of Array.from(yield(0,l.waitForElements)(".group_towns span.town_name",3e3)))if(console.log("\t\t-element to match, element searched:",e.textContent,o.textContent),e.textContent===o.textContent){console.log("\t\t\t-found matched element:",e,"click it"),e.click();break}yield(0,a.addDelay)(100),document.querySelector(".btn_jump_to_town.circle_button.jump_to_town").click(),console.log("\t-click",document.querySelector(".btn_jump_to_town.circle_button.jump_to_town"));const c=null!==(r=null===(i=null===(n=Array.from(null!==(t=null===(e=yield(0,l.waitForElement)(`#town_${s}`,3e3))||void 0===e?void 0:e.classList)&&void 0!==t?t:[]).find((e=>e.match(/town_\d+_\d+_\d+/))))||void 0===n?void 0:n.match(/town_(\d+_\d+)_\d+/))||void 0===i?void 0:i[1])&&void 0!==r?r:"",u=o.textContent;h.push({name:u,cityId:s,isleId:c,switchAction:this.switchActionForCity(u)})}return console.log("CitySwitchManager.cityList.initialized:",h),yield this.goBackToFirstTown(),this.generalInfo.hideInfo(),localStorage.setItem(c.LOCAL_STORAGE_CITY_LIST_KEY,JSON.stringify(h)),h}))}openTownList(){return i(this,void 0,void 0,(function*(){(yield(0,l.waitForElement)(".group_towns",1e3).catch((()=>null)))||(yield(0,l.waitForElement)(".town_groups_dropdown.btn_toggle_town_groups_menu")).click()}))}hydrateCityList(e){for(const t of e)t.switchAction=this.switchActionForCity(t.name);return e}goBackToFirstTown(){return i(this,void 0,void 0,(function*(){document.querySelector(".btn_next_town.button_arrow.right").click(),document.querySelector(".btn_jump_to_town.circle_button.jump_to_town").click()}))}clickArrowUntilCityFound(e){return i(this,void 0,void 0,(function*(){const t=document.querySelector(".town_name_area"),n=t.querySelector(".btn_prev_town.button_arrow.left"),i=t.querySelector(".btn_next_town.button_arrow.right");do{if(i.click(),yield(0,a.addDelay)(1500),document.querySelector("div.town_name").textContent===e)return}while(i.classList.contains("disabled"));do{if(n.click(),yield(0,a.addDelay)(1500),document.querySelector("div.town_name").textContent===e)return}while(!n.classList.contains("disabled"))}))}getCurrentCity(){var e,t;const n=null!==(t=null===(e=document.querySelector("div.town_name"))||void 0===e?void 0:e.textContent)&&void 0!==t?t:"";return this.getCityByName(n)}getCityByName(e){return this.cityList.find((t=>t.name===e))}getCityList(){return this.cityList}isRunning(){return this.RUN}run(){this.RUN=!0}stop(){this.RUN=!1}}c.LOCAL_STORAGE_CITY_LIST_KEY="cityList",t.default=c},543:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function l(e){try{s(i.next(e))}catch(e){o(e)}}function a(e){try{s(i.throw(e))}catch(e){o(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(l,a)}s((i=i.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.FarmingSolution=void 0;const o=r(n(7)),l=n(773),a=r(n(639)),s=n(910),c=r(n(785)),u=n(396),d=r(n(2)),h=r(n(715)),m=n(388);var g;!function(e){e[e.Captain=0]="Captain",e[e.Manual=1]="Manual"}(g||(t.FarmingSolution=g={}));class f extends o.default{constructor(){super(),this.schedulerArray=[],this.captainScheduler=null,this.messageDialogObserver=null,this.humanMessageDialogObserver=null,this.farmSolution=g.Manual,this.RUN=!1,this.scheduleNextFarmingOperationForCity=(e,t)=>{const n={scheduledDate:new Date(Date.now()+e),timeout:null,city:t},r=setTimeout((()=>i(this,void 0,void 0,(function*(){this.schedulerArray=this.schedulerArray.filter((e=>e!==n)),this.farmVillages(t)}))),e);n.timeout=r,this.schedulerArray.push(n),console.log("scheduler:",this.schedulerArray)},this.mountMessageDialogsObservers=e=>i(this,void 0,void 0,(function*(){if(!this.messageDialogObserver){const e=new MutationObserver((e=>i(this,void 0,void 0,(function*(){for(const t of e)if("childList"===t.type)for(const e of t.addedNodes)if(e instanceof HTMLElement&&"window_curtain ui-front show_curtain is_modal_window"===e.getAttribute("class"))return yield(0,s.addDelay)(100),void e.querySelector(".btn_confirm.button_new").click()}))));this.messageDialogObserver=e,this.messageDialogObserver.observe(document.body,{childList:!0})}if(!this.humanMessageDialogObserver&&e){const t=new MutationObserver((n=>i(this,void 0,void 0,(function*(){for(const i of n)"childList"===i.type&&(t.disconnect(),yield e.switchAction())}))));this.humanMessageDialogObserver=t,t.observe(document.querySelector("#human_message"),{childList:!0,subtree:!0})}this.messageDialogObserver.observe(document.body,{childList:!0})}))}static getInstance(){return i(this,void 0,void 0,(function*(){return f.instance||(f.instance=new f,f.instance.generalInfo=h.default.getInstance(),f.instance.citySwitch=yield d.default.getInstance(),f.instance.config=a.default.getInstance().getConfig(),f.instance.lock=c.default.getInstance(),yield f.instance.setFarmSolution()),f.instance}))}setFarmSolution(){return i(this,void 0,void 0,(function*(){const e=yield(0,u.waitForElement)(".advisor_frame.captain .advisor",4e3).then((e=>e.classList.contains("captain_active"))).catch((()=>!1));this.farmSolution=e?g.Captain:g.Manual}))}getFarmSolution(){return this.farmSolution}getFarmScheduleTimes(){var e;return this.farmSolution===g.Captain?[null===(e=this.captainScheduler)||void 0===e?void 0:e.scheduledDate]:this.schedulerArray.map((e=>e.scheduledDate))}farmWithCaptain(){return i(this,arguments,void 0,(function*(e=!1){var t,n,r,o,l,a,c,d,h;let g=[];try{yield this.lock.acquire({method:"farmWithCaptain",manager:"farmManager"}),this.generalInfo.showInfo("Farm Manager:","Farmienie z kapitanem."),console.log("farmWithCaptain at ",new Date),this.mountMessageDialogsObservers(),g=Array.from(document.querySelectorAll('[role="dialog"]')),document.querySelector('[name="farm_town_overview"]').click(),this.config.farmConfig.humanize?yield(0,s.addDelay)((0,s.getRandomMs)(400,1200)):(0,s.addDelay)(100);{let e=yield(0,u.waitForElementInterval)(".ribbon_wrapper",{retries:4,interval:400}).catch((()=>{throw new m.InfoError("cooldownWrapper not found, cannot proceed",{browserState:(0,s.getBrowserStateSnapshot)(),elementState:(0,s.getElementStateSnapshot)(document.querySelector(".ribbon_wrapper"))})}));if(!e.classList.contains("hidden")){let i;for(console.log("cooldownWrapper found, not hidden");!(i=null===(r=null===(n=null===(t=e.querySelector(".ribbon_locked .unlock_time"))||void 0===t?void 0:t.textContent)||void 0===n?void 0:n.match(/\d{2}:\d{2}:\d{2}/))||void 0===r?void 0:r[0]);)yield(0,s.addDelay)(333);const o=(0,s.calculateTimeToNextOccurrence)(i)+this.config.general.timeDifference+1e3,l=new Date(Date.now()+o);console.log("schedule next farming operation for captain on:",l);const a=setTimeout((()=>{console.log("performing scheduled farming operation for captain, at:",(0,s.formatDateToSimpleString)(new Date)),this.farmWithCaptain(!0)}),o);return void(this.captainScheduler={scheduledDate:l,timeout:a})}}for(;null===(o=document.querySelector("#fto_town_wrapper .button.button_new"))||void 0===o?void 0:o.classList.contains("disabled");)yield(0,s.addDelay)(500);console.log("clicked select all"),yield(0,u.waitForElementInterval)("#fto_town_wrapper .checkbox.select_all",{retries:4,interval:500}).then((e=>e.click())).then((()=>i(this,void 0,void 0,(function*(){for(var e;!(null===(e=document.querySelector("#fto_town_wrapper .checkbox.select_all"))||void 0===e?void 0:e.classList.contains("checked"));)yield(0,s.addDelay)(500)})))),this.config.farmConfig.humanize&&(yield(0,s.addDelay)((0,s.getRandomMs)(400,1200)));const e=document.querySelectorAll("#fto_town_wrapper .gp_town_link");for(const t of this.config.farmConfig.farmingCities)for(const n of e)if(n.textContent===t.name){const e=n.parentElement.querySelector(".checkbox.town_checkbox");if(!e.classList.contains("checked")){console.log("clicking town checkbox",t.name),e.click(),yield(0,s.addDelay)(100);break}}console.log("select farm options"),yield(0,s.addDelay)(500);const f=document.querySelectorAll(".fto_time_checkbox"),p=this.getFarmOptionIndex();let v;!f[p].classList.contains("checked")&&f[p].click(),this.config.farmConfig.humanize?yield(0,s.addDelay)((0,s.getRandomMs)(400,1200)):(0,s.addDelay)(100),!(null===(l=f[p+4])||void 0===l?void 0:l.classList.contains("checked"))&&(null===(a=f[p+4])||void 0===a||a.click()),this.config.farmConfig.humanize?yield(0,s.addDelay)((0,s.getRandomMs)(400,1200)):(0,s.addDelay)(100),console.log("collecting resources"),yield(0,u.waitForElementInterval)("#fto_claim_button",{retries:4,interval:400}).then((e=>e.click())).catch((()=>{throw new Error("collecting resources failed, no button found")})),this.config.farmConfig.humanize?yield(0,s.addDelay)((0,s.getRandomMs)(400,1200)):(0,s.addDelay)(100),console.log("finding new cooldown");let y=0;for(;!(v=null===(h=null===(d=null===(c=document.querySelector(".ribbon_wrapper .ribbon_locked .unlock_time"))||void 0===c?void 0:c.textContent)||void 0===d?void 0:d.trim().match(/\d{2}:\d{2}:\d{2}/))||void 0===h?void 0:h[0])&&y<5;)yield(0,s.addDelay)(400),y++;if(8===y)throw new Error("new cooldown not found, cannot schedule properly");const b=(0,s.calculateTimeToNextOccurrence)(v)+this.config.general.timeDifference+1e3,w=new Date(Date.now()+b);console.log("schedule next farming operation for captain on:",w);const S=setTimeout((()=>{console.log("performing scheduled farming operation for captain, at:",(0,s.formatDateToSimpleString)(new Date)),this.farmWithCaptain(!0)}),b);this.captainScheduler={scheduledDate:w,timeout:S},console.log("farmManager.farmWithCaptain.succesfullSnapchot",(0,s.getBrowserStateSnapshot)())}catch(e){e instanceof m.InfoError?console.warn("FarmManager.farmWithCaptain().catch",e.message,e.details,"will reschedule in 2 minutes"):console.warn("FarmManager.farmWithCaptain().catch",e,"will reschedule in 2 minutes"),this.captainScheduler={timeout:setTimeout((()=>{this.farmWithCaptain()}),12e4),scheduledDate:new Date(Date.now()+12e4)}}finally{console.log("captain scheduler:",this.captainScheduler),this.tryCloseCurrentDialog(Array.from(g)),this.disconnectObservers(),this.generalInfo.hideInfo(),this.lock.release()}}))}start(){return i(this,void 0,void 0,(function*(){this.RUN||(console.log("FarmManager started"),this.RUN=!0,yield this.initFarmAllVillages())}))}tryCloseCurrentDialog(e){var t;const n=document.querySelectorAll('[role="dialog"]'),i=Array.from(n).find((t=>!e.includes(t)));null===(t=null==i?void 0:i.querySelector(".ui-dialog-titlebar-close"))||void 0===t||t.click()}ensureAllChecbkoxesUnchecked(){return i(this,void 0,void 0,(function*(){const e=yield(0,u.waitForElementInterval)("#fto_town_wrapper .checkbox.select_all",{timeout:2e3,interval:400});e.classList.contains("checked")&&(e.click(),yield(0,s.addDelay)(100));const t=yield(0,u.waitForElementsInterval)("#fto_town_wrapper .checkbox.town_checkbox",{timeout:2e3,interval:400});for(const e of t)e.classList.contains("checked")&&(e.click(),yield(0,s.addDelay)(100))}))}farmVillages(e){return i(this,void 0,void 0,(function*(){try{console.log("farmVillages, wait for lock",e.name),yield this.lock.acquire(),this.generalInfo.showInfo("Farm Manager:",`farmienie w mieście: ${e.name}`),console.log("farmVillages, take lock",e.name),yield this.farmVillagesFlow(e)}catch(e){console.warn("FarmManager.farmVillages().catch",e)}finally{this.disconnectObservers(),console.log("farmVillages, release lock",e.name),this.generalInfo.hideInfo(),this.lock.release(),this.emit("farmingFinished")}}))}farmVillagesFlow(e){return i(this,arguments,void 0,(function*(e,t=!1){var n;try{console.log("farmVillagesFlow, switch to city",e.name,new Date),yield e.switchAction();let t=this.config.farmConfig.farmInterval;this.config.farmConfig.humanize?(0,s.addDelay)((0,s.getRandomMs)(400,1200)):(0,s.addDelay)(333);const i=yield(0,u.waitForElementsInterval)('a.owned.farm_town[data-same_island="true"]',{timeout:3e3}).catch((()=>null));if(console.log("\t-villages to farm:",null==i?void 0:i.length),!i||0===i.length)return;const r=Array.from(i).map((e=>`[style="${e.getAttribute("style")}"]`)),o=r.length;this.mountMessageDialogsObservers(e);for(const[i,l]of r.entries()){console.log(`\t-checking village: ${i}, from town: ${e.name}`);let r=0;do{if(console.log("\t-clicking village element on the map",r),yield(0,u.performComplexClick)(document.querySelector(l)),console.log("\t-clicked village element on the map",r),yield(0,s.addDelay)(100),3===r)throw new Error("Farm villages dialog didn't show up");r++}while(!(yield(0,u.waitForElementInterval)(".farm_towns",{retries:3,interval:500}).catch((()=>!1))));this.config.farmConfig.humanize?yield(0,s.addDelay)((0,s.getRandomMs)(400,1200)):(0,s.addDelay)(100);const a=this.getFarmOptionIndex();r=0;do{if(console.log("\t-clicking farm button",r),yield(0,u.waitForElements)(".btn_claim_resources.button.button_new",500).then((e=>e[a].click())).catch((()=>{})),console.log("\t-clicked farm button",r),3===r)throw new Error("Farm button not found");r++,yield(0,s.addDelay)(100)}while(!(yield(0,u.waitForElement)(".actions_locked_banner.cooldown",1500).catch((()=>!1))));this.config.farmConfig.humanize?yield(0,s.addDelay)((0,s.getRandomMs)(400,1200)):(0,s.addDelay)(100),i===o-1&&(t=null!==(n=yield this.getUnlockTimeOrNull(yield(0,u.waitForElement)(".farm_towns"),2e3))&&void 0!==n?n:this.config.farmConfig.farmInterval),console.log("\t-closing village window"),yield(0,u.waitForElement)(".btn_wnd.close",2e3).then((e=>e.click())).catch((()=>{})),console.log("\t-closed village window"),this.config.farmConfig.humanize?yield(0,s.addDelay)((0,s.getRandomMs)(400,1200)):(0,s.addDelay)(100)}this.disconnectObservers(),this.scheduleNextFarmingOperationForCity(t+1e3,e)}catch(t){console.warn("FarmManager.farmVillagesFlow().catch",t),yield this.forceRepeatFarming(e)}}))}initFarmAllVillages(){return i(this,void 0,void 0,(function*(){var e;if(this.farmSolution===g.Captain)yield this.farmWithCaptain();else{const t=this.config.farmConfig.farmingCities.map((e=>this.citySwitch.getCityList().find((t=>t.name===e.name))));try{console.log("initFarmAllVillages, wait for lock",new Date),yield this.lock.acquire({method:"initFarmAllVillages",manager:"farmManager"}),this.generalInfo.showInfo("Farm Manager:","Inicjalizacja/farmienie wszystkich wiosek."),console.log("initFarmAllVillages, take lock",new Date);for(const e of t)yield this.farmVillagesFlow(e);1!==t.length&&(yield t[0].switchAction())}catch(e){console.warn("FarmManager.initFarmAllVillages().catch",e)}finally{this.generalInfo.hideInfo(),this.lock.release(),null===(e=this.messageDialogObserver)||void 0===e||e.disconnect(),this.emit("farmingFinished")}}}))}forceRepeatFarming(e){return i(this,void 0,void 0,(function*(){yield e.switchAction(),yield this.farmVillagesFlow(e,!0)}))}disconnectObservers(){var e,t;null===(e=this.messageDialogObserver)||void 0===e||e.disconnect(),null===(t=this.humanMessageDialogObserver)||void 0===t||t.disconnect()}getUnlockTimeOrNull(e,t){return i(this,void 0,void 0,(function*(){const n=yield(0,u.waitForElementFromNode)(e,".actions_locked_banner.cooldown",null!=t?t:500).catch((()=>null));if(n){const e=n.querySelector(".pb_bpv_unlock_time");return new Promise(((t,n)=>{let i=0;const r=setInterval((()=>{(null==e?void 0:e.textContent)?(clearInterval(r),console.log("next unlock time:",e.textContent),t((0,s.textToMs)(e.textContent))):10===i&&(clearInterval(r),console.warn("nie znaleziono czasu odblokowania"),t(null)),i++}),100)}))}return null}))}getFarmOptionIndex(){switch(this.config.farmConfig.farmInterval){case l.FarmTimeInterval.FirstOption:return 0;case l.FarmTimeInterval.SecondOption:return 1;case l.FarmTimeInterval.ThirdOption:return 2;case l.FarmTimeInterval.FourthOption:return 3;default:return 0}}getFarmOptionTimeRegex(){switch(this.config.farmConfig.farmInterval){case l.FarmTimeInterval.FirstOption:return/(5|10)/;case l.FarmTimeInterval.SecondOption:return/^(20|40)/;case l.FarmTimeInterval.ThirdOption:return/^(1.*30|3\D+)/;case l.FarmTimeInterval.FourthOption:return/^(4|8)h/;default:return/^(5|10)/}}getFarmOption(){return Array.from(document.querySelectorAll(".btn_claim_resources.button.button_new")).find((e=>{var t;return this.getFarmOptionTimeRegex().test(null!==(t=e.textContent)&&void 0!==t?t:"")}))}stop(){this.RUN=!1,console.log("FarmManager stopped"),this.schedulerArray.forEach((e=>{clearTimeout(e.timeout)})),this.schedulerArray=[],this.captainScheduler&&clearTimeout(this.captainScheduler.timeout),this.captainScheduler=null}isRunning(){return this.RUN}}t.default=f},299:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function l(e){try{s(i.next(e))}catch(e){o(e)}}function a(e){try{s(i.throw(e))}catch(e){o(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(l,a)}s((i=i.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(773),l=r(n(323)),a=r(n(639)),s=n(910),c=r(n(233)),u=r(n(2)),d=r(n(543)),h=r(n(803)),m=r(n(567)),g=r(n(715));class f{constructor(){this.pausedManagersSnapshot={farmManager:!1,scheduler:!1,builder:!1,recruiter:!1}}static getInstance(){return i(this,void 0,void 0,(function*(){return f.instance||(f.instance=new f,f.instance.generalInfo=g.default.getInstance(),f.instance.config=a.default.getInstance().getConfig(),f.instance.switchManager=yield u.default.getInstance(),f.instance.farmManager=yield d.default.getInstance(),f.instance.scheduler=yield m.default.getInstance(),f.instance.builder=yield c.default.getInstance(),f.instance.recruiter=yield h.default.getInstance(),f.instance.initCaptchaPrevention(),f.instance.initRefreshUtility(),f.instance.initConfigDialog()),f.instance}))}initRefreshUtility(e){setTimeout((()=>i(this,void 0,void 0,(function*(){const t=yield m.default.getInstance(),n=!t.isRunning()||t.canSafelyRefresh();n?(console.log("canRefresh, will refresh",n),console.log("timeout ?? this.config.general.applicationRefreshInterval",null!=e?e:this.config.general.applicationRefreshInterval),console.log("this.config.general.applicationRefreshInterval",this.config.general.applicationRefreshInterval),this.config.general.forcedRefresh=!0,a.default.getInstance().persistConfig(),yield(0,s.addDelay)(1e4),window.location.reload()):(console.log("canRefresh",n),this.initRefreshUtility(3e5))}))),null!=e?e:1e3*(this.config.general.applicationRefreshInterval+(Math.floor(121*Math.random())-60)))}initCaptchaPrevention(){new MutationObserver((e=>i(this,void 0,void 0,(function*(){for(const t of e)if("childList"===t.type){const e=document.querySelector("#recaptcha_window"),t=document.querySelector("#captcha_curtain");if(e){const t=e.querySelector('[class="recaptcha-checkbox-border"]');if(t){yield(0,s.addDelay)(4e3),t.click();const n=e.querySelector('#recaptcha_window [class="caption js-caption"]');n&&(yield(0,s.addDelay)(4e3),n.click())}}else if(t){const e=t.querySelector('[class="captcha-checkbox-border"]');if(e){yield(0,s.addDelay)(2e3),e.click();const n=t.querySelector('#captcha_curtain [class="caption js-caption"]');n&&(yield(0,s.addDelay)(2e3),n.click())}}}})))).observe(document.body,{childList:!0})}runManagersFromConfig(e){return i(this,void 0,void 0,(function*(){this.configMenuWindow.isBuilderChecked()?this.builder.isRunning()||(console.log("Builder will be started..."),this.builder.start()):this.builder.isRunning()&&(console.log("Builder will be stopped..."),this.builder.stop()),this.configMenuWindow.isFarmChecked()?this.farmManager.isRunning()||(console.log("FarmManager will be started..."),yield this.farmManager.start()):this.farmManager.isRunning()&&(console.log("FarmManager will be stopped..."),this.farmManager.stop()),this.configMenuWindow.isRecruiterChecked()?this.recruiter.isRunning()||(console.log("Recruiter will be started..."),this.recruiter.start()):this.recruiter.isRunning()&&(console.log("Recruiter will be stopped..."),this.recruiter.stop()),e&&(0,s.hasAnyValue)(e.recruiter,!0)&&this.recruiter.handleRecruiterConfigChange(e.recruiter)}))}initConfigDialog(){return i(this,void 0,void 0,(function*(){this.configMenuWindow=new l.default,this.configMenuWindow.addListener("managersChange",(e=>i(this,void 0,void 0,(function*(){yield this.runManagersFromConfig(e)})))),yield this.configMenuWindow.render(),(this.config.general.forcedRefresh||(0,s.getCookie)("forceRestart"))&&(console.log("forcedRefresh/forceRestart",this.config.general.forcedRefresh,(0,s.getCookie)("forceRestart")),this.config.general.forcedRefresh=!1,(0,s.setCookie)("forceRestart",!1),this.config.farmConfig.farmInterval=o.FarmTimeInterval.FirstOption,a.default.getInstance().persistConfig(),this.configMenuWindow.minimize(),yield this.runManagersFromConfig())}))}run(){this.runManagersFromConfig()}pauseRunningManagers(e){console.log("pauseRunningManagers",this.pausedManagersSnapshot),!e.includes("farmManager")&&this.farmManager.isRunning()&&(this.farmManager.stop(),this.pausedManagersSnapshot.farmManager=!0),!e.includes("scheduler")&&this.scheduler.isRunning()&&(this.scheduler.stop(),this.pausedManagersSnapshot.scheduler=!0),!e.includes("builder")&&this.builder.isRunning()&&(this.builder.stop(),this.pausedManagersSnapshot.builder=!0),!e.includes("recruiter")&&this.recruiter.isRunning()&&(this.recruiter.stop(),this.pausedManagersSnapshot.recruiter=!0),console.log("pauseRunningManagers",this.pausedManagersSnapshot)}pauseRunningManagersIfNeeded(e,t){console.log("pauseRunningManagers",this.pausedManagersSnapshot),!t.includes("farmManager")&&this.farmManager.isRunning()&&this.farmManager.getFarmScheduleTimes().some((t=>t&&t.getTime()<=e&&Math.abs(t.getTime()-e)<=2e4))&&(this.farmManager.stop(),this.pausedManagersSnapshot.farmManager=!0),!t.includes("recruiter")&&this.recruiter.isRunning()&&this.recruiter.getRecruitmentScheduleTimes().some((t=>t&&t<=e&&Math.abs(t-e)<=3e4))&&(this.recruiter.stop(),this.pausedManagersSnapshot.recruiter=!0),!t.includes("scheduler")&&this.scheduler.isRunning()&&(this.scheduler.stop(),this.pausedManagersSnapshot.scheduler=!0),!t.includes("builder")&&this.builder.isRunning()&&this.builder.getBuilderScheduleTimes().some((t=>t&&t.getTime()<=e&&Math.abs(t.getTime()-e)<=2e4))&&(this.builder.stop(),this.pausedManagersSnapshot.builder=!0),console.log("pauseRunningManagers",this.pausedManagersSnapshot)}resumeRunningManagers(e){console.log("resumeRunningManagers",this.pausedManagersSnapshot),Object.entries(this.pausedManagersSnapshot).forEach((([t,n])=>{switch(t){case"farmManager":n&&!e.includes("farmManager")&&this.farmManager.start();break;case"recruiter":n&&!e.includes("recruiter")&&this.recruiter.start();break;case"scheduler":n&&!e.includes("scheduler")&&this.scheduler.run();break;case"builder":n&&!e.includes("builder")&&this.builder.start()}})),Object.keys(this.pausedManagersSnapshot).forEach((t=>{e.includes(t)&&(this.pausedManagersSnapshot[t]=!1)}))}forceRefresh(){this.config.general.forcedRefresh=!0,a.default.getInstance().persistConfig(),window.location.reload()}stopAll(){this.farmManager.stop(),this.switchManager.stop(),this.scheduler.stop(),this.builder.stop()}}t.default=f},715:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=i(n(39)),o=i(n(41));class l{constructor(){this.initInfoContainer()}static getInstance(){return l.instance||(l.instance=new l),l.instance}initInfoContainer(){console.log("initInfoContainer");const e=document.createElement("style");e.innerHTML=r.default,document.head.appendChild(e);const t=document.createElement("div");t.innerHTML=o.default,document.body.appendChild(t)}showInfo(e,t){const n=document.getElementById("info-container");n.querySelector(".info-title").textContent=e,n.querySelector(".info-text").textContent=t,n.classList.remove("hidden")}hideInfo(){document.getElementById("info-container").classList.add("hidden")}}t.default=l},803:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function l(e){try{s(i.next(e))}catch(e){o(e)}}function a(e){try{s(i.throw(e))}catch(e){o(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(l,a)}s((i=i.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=r(n(639)),l=n(388),a=n(910),s=r(n(785)),c=n(396),u=r(n(2)),d=r(n(715)),h=r(n(254)),m=r(n(11)),g=r(n(881)),f=r(n(319));class p{constructor(){this.tryCount=0,this.RUN=!1,this.observer=null,this.unitChangeObserver=null,this.recruitmentBuildingDialogAttr=null,this.currentUnitContext=null,this.recruitmentSchedule=[],this.eventListenersCleanupCallbacks=[]}static getInstance(){return i(this,void 0,void 0,(function*(){return p.instance||(p.instance=new p,p.instance.addCSS(),p.instance.resourceManager=yield h.default.getInstance(),p.instance.lock=s.default.getInstance(),p.instance.citySwitchManager=yield u.default.getInstance()),p.instance}))}addCSS(){const e=document.createElement("style");e.textContent=f.default,document.head.appendChild(e)}getRecruitmentScheduleTimes(){return this.recruitmentSchedule.map((e=>e.nextScheduledTime)).filter((e=>null!=e))}addRecruiterDialog(){const e=document.createElement("div");e.id="recruiter-container",e.style.zIndex="2000",e.innerHTML=m.default,document.body.appendChild(e)}createRecruiterToggleButton(){const e=document.createElement("div");return e.id="recruiter-toggle-container",e.innerHTML=g.default,e}removeRecruiterDialog(){var e;null===(e=document.getElementById("recruiter-container"))||void 0===e||e.remove()}handleRecruiterConfigChange(e){console.log("handleRecruiterConfigChange():",e),e.autoReevaluate&&o.default.getInstance().getConfig().recruiter.autoReevaluate&&(console.log("reevaluating provider cities"),this.reevaluateProviderCities())}reevaluateProviderCities(){const e=this.recruitmentSchedule.map((e=>e.city));this.recruitmentSchedule.forEach((t=>{t.queue.forEach((t=>{t.suppliersCities=t.suppliersCities.filter((t=>!e.includes(t)))}))}))}start(){return i(this,void 0,void 0,(function*(){console.log("recruiter start"),this.RUN=!0,this.observer||(this.observer=this.mountObserver()),this.recruitmentSchedule.forEach((e=>{e.queue.length&&this.tryRecruitOrStackResources(e)}))}))}stop(){return i(this,void 0,void 0,(function*(){var e,t;this.RUN=!1,this.recruitmentSchedule.forEach((e=>{e.timeoutId&&clearTimeout(e.timeoutId),e.timeoutId=null,e.nextScheduledTime=null})),null===(e=this.observer)||void 0===e||e.disconnect(),null===(t=this.unitChangeObserver)||void 0===t||t.disconnect(),this.observer=null,this.unitChangeObserver=null}))}isRunning(){return this.RUN}mountObserver(){const e=e=>i(this,void 0,void 0,(function*(){e instanceof HTMLElement&&"dialog"===e.getAttribute("role")&&((0,c.waitForElementInterval)(".barracks_building",{fromNode:e,interval:500,retries:3}).then((()=>{this.recruitmentBuildingDialogAttr=e.getAttribute("aria-describedby"),console.log("barracks dialog attr:",this.recruitmentBuildingDialogAttr),this.extendUI(e,"barracks")})).catch((()=>{})),(0,c.waitForElementInterval)(".docks_building",{fromNode:e,interval:500,retries:3}).then((()=>{this.recruitmentBuildingDialogAttr=e.getAttribute("aria-describedby"),console.log("docks dialog attr:",this.recruitmentBuildingDialogAttr),this.extendUI(e,"docks")})).catch((()=>{})))})),t=e=>i(this,void 0,void 0,(function*(){var t;e instanceof HTMLElement&&"dialog"===e.getAttribute("role")&&e.getAttribute("aria-describedby")===this.recruitmentBuildingDialogAttr&&(console.log("Unmounting recruiter utilities"),this.removeRecruiterDialog(),null===(t=this.unitChangeObserver)||void 0===t||t.disconnect(),this.unitChangeObserver=null,this.cleanEventListeners())})),n=new MutationObserver((n=>{for(const i of n)if("childList"===i.type){for(const t of i.addedNodes)e(t);for(const e of i.removedNodes)t(e)}}));return n.observe(document.body,{childList:!0}),n}extendUI(e,t){var n,i,r;null===(n=e.querySelector("#unit_order"))||void 0===n||n.appendChild(this.createRecruiterToggleButton()),this.addRecruiterDialog(),this.addEntryEventListener(e,t),this.attachOnCityChangeCallback(),this.mountUnitChangeObserver(),this.renderRecruitmentQueue(null!==(r=null===(i=this.recruitmentSchedule.find((e=>{var t;return e.city.name===(null===(t=this.citySwitchManager.getCurrentCity())||void 0===t?void 0:t.name)})))||void 0===i?void 0:i.queue)&&void 0!==r?r:[])}addEntryEventListener(e,t){const n=document.getElementById("recruiter-btn"),r=document.getElementById("recruiter-dialog");let o=!1;const l=()=>i(this,void 0,void 0,(function*(){r.hidden?(r.hidden=!1,yield this.setCurrentUnitContext(),this.setDialogCurrentUnitImage()):r.hidden=!0,o||(this.addEventListeners(t),o=!0)}));null==n||n.addEventListener("click",l),this.eventListenersCleanupCallbacks.push((()=>null==n?void 0:n.removeEventListener("click",l)))}attachOnCityChangeCallback(){const e=e=>i(this,void 0,void 0,(function*(){var t,n;this.populateCitiesSelect(),this.renderRecruitmentQueue(null!==(n=null===(t=this.recruitmentSchedule.find((t=>t.city.name===e.name)))||void 0===t?void 0:t.queue)&&void 0!==n?n:[])}));this.citySwitchManager.addListener("cityChange",e),this.eventListenersCleanupCallbacks.push((()=>this.citySwitchManager.removeListener("cityChange",e)))}mountUnitChangeObserver(){var e;const t=document.querySelector(`[aria-describedby="${this.recruitmentBuildingDialogAttr}"]`),n=new MutationObserver((e=>i(this,void 0,void 0,(function*(){var t;for(const n of e)n.target.classList.contains("unit_active")&&(console.log("Class attribute matched:",n.target),(null===(t=document.getElementById("recruiter-dialog"))||void 0===t?void 0:t.hidden)||(yield this.setCurrentUnitContext(),this.setDialogCurrentUnitImage()))}))));n.observe(t,{attributes:!0,subtree:!0,attributeFilter:["class"]}),null===(e=this.unitChangeObserver)||void 0===e||e.disconnect(),this.unitChangeObserver=n}addEventListeners(e){return i(this,void 0,void 0,(function*(){this.populateCitiesSelect();const t=document.getElementById("recruiter-dialog"),n=null==t?void 0:t.querySelector("#recruiter-nav"),r=null==t?void 0:t.querySelector(".recruiter-dialog-header-icon"),l=null==t?void 0:t.querySelector("#recruiter-close-btn"),a=null==t?void 0:t.querySelector("#recruiter-confirm-btn"),s=null==t?void 0:t.querySelector("#recruiter-add-btn"),c=null==t?void 0:t.querySelector("#recruiter-cancel-btn"),u=null==t?void 0:t.querySelectorAll('[name="recruiter-type"]'),d=null==t?void 0:t.querySelector("#recruiter-ammount"),h=null==t?void 0:t.querySelector("#recruiter-amount-max"),m=null==t?void 0:t.querySelector("#recruiter-cities"),g=null==t?void 0:t.querySelector("#shipment-time");console.log("this.currentUnitContext:",this.currentUnitContext),null==c||c.addEventListener("click",(()=>{console.log("cancel");const e=this.citySwitchManager.getCurrentCity();e&&(this.recruitmentSchedule=this.recruitmentSchedule.filter((t=>t.city.name!==e.name||(t.timeoutId&&clearTimeout(t.timeoutId),t.nextScheduledTime=null,!1))),this.renderRecruitmentQueue([]))}));const f=()=>{console.log("amount max checkbox changed:",h.checked),h.checked?d.disabled=!0:d.disabled=!1};null==h||h.addEventListener("change",f),this.eventListenersCleanupCallbacks.push((()=>null==h?void 0:h.removeEventListener("change",f))),h.checked?d.disabled=!0:d.disabled=!1;const p=()=>{console.log("confirm");const e=this.recruitmentSchedule.find((e=>{var t;return e.city.name===(null===(t=this.citySwitchManager.getCurrentCity())||void 0===t?void 0:t.name)}));if(!e)throw new Error("No scheduler items in the queue");o.default.getInstance().getConfig().recruiter.autoReevaluate&&(this.reevaluateProviderCities(),console.log("provider cities reevaluated, schedule:",this.recruitmentSchedule)),this.persistSchedule(),1!==e.queue.length&&(e.timeoutId||e.nextScheduledTime)||this.tryRecruitOrStackResources(e),t.hidden=!0};null==a||a.addEventListener("click",p),this.eventListenersCleanupCallbacks.push((()=>null==a?void 0:a.removeEventListener("click",p)));const v=()=>{console.log("close"),t.hidden=!0};null==l||l.addEventListener("click",v),this.eventListenersCleanupCallbacks.push((()=>null==l?void 0:l.removeEventListener("click",v)));const y=()=>i(this,void 0,void 0,(function*(){console.log("refresh"),yield this.setCurrentUnitContext(),this.setDialogCurrentUnitImage(),this.populateCitiesSelect()}));null==r||r.addEventListener("click",y),this.eventListenersCleanupCallbacks.push((()=>null==r?void 0:r.removeEventListener("click",y)));const b=()=>{const t=u[0].checked?"units":"slots",n=d.value,i=h.checked,r=Array.from(m.selectedOptions).map((e=>e.value)),l=this.citySwitchManager.getCurrentCity(),a=Number(g.value);console.log("amountType:",t,"amountInputValue:",n,"amountMaxCheckboxValue:",i,"citiesSelectValue:",r,"sourceCity:",l,"shipmentTime:",a);const s=this.recruitmentSchedule.find((e=>e.city.name===(null==l?void 0:l.name)));console.log("scheduleExists:",s);const c=null!=s?s:{city:l,nextScheduledTime:null,timeoutId:null,queue:[]};console.log("schedule:",c);let f=r.map((e=>this.citySwitchManager.getCityByName(e))).filter((e=>void 0!==e&&e.name!==(null==l?void 0:l.name)));if(o.default.getInstance().getConfig().recruiter.autoReevaluate){const e=this.recruitmentSchedule.map((e=>e.city.name));f=f.filter((t=>!e.includes(t.name)))}if(console.log("selectedCities:",f),i){console.log("amountMaxCheckboxValue:",i);const t=this.getEmptySlotsCount(e)-c.queue.reduce(((e,t)=>e+("slots"===t.amountType?t.amount:1)),0);c.queue.push({unitContextInfo:this.getCurrentUnitContextCopy(),amountType:"slots",amount:t,amountLeft:t,type:e,suppliersCities:f,maxShipmentTime:a}),console.log("slots queue item added, schedule:",c)}else"units"===t?(console.log("units queue item added, schedule:",c),c.queue.push({unitContextInfo:this.getCurrentUnitContextCopy(),amountType:"units",amount:Number(n),amountLeft:Number(n),type:e,suppliersCities:f,maxShipmentTime:a})):"slots"===t&&(console.log("slots queue item added, schedule:",c),c.queue.push({unitContextInfo:this.getCurrentUnitContextCopy(),amountType:"slots",amount:Number(n),amountLeft:Number(n),type:e,suppliersCities:f,maxShipmentTime:a}));s||(console.log("schedue does not exist, pushing new schedule"),this.recruitmentSchedule.push(c)),this.renderRecruitmentQueue(c.queue)};null==s||s.addEventListener("click",b),this.eventListenersCleanupCallbacks.push((()=>null==s?void 0:s.removeEventListener("click",b)));{let w=!1,S=null,_=null;function C(e){w=!0,S=e.clientX-t.offsetLeft,_=e.clientY-t.offsetTop,document.addEventListener("mousemove",x),document.addEventListener("mouseup",k)}function x(e){w&&(t.style.left=e.clientX-(null!=S?S:0)+"px",t.style.top=e.clientY-(null!=_?_:0)+"px")}function k(){w=!1,document.removeEventListener("mousemove",x),document.removeEventListener("mouseup",k)}null==n||n.addEventListener("mousedown",C),this.eventListenersCleanupCallbacks.push((()=>{null==n||n.removeEventListener("mousedown",C),document.removeEventListener("mousemove",x),document.removeEventListener("mouseup",k)}))}}))}persistSchedule(){localStorage.setItem("recruitmentSchedule",JSON.stringify(this.recruitmentSchedule))}loadSchedule(){const e=localStorage.getItem("recruitmentSchedule");e&&(this.recruitmentSchedule=JSON.parse(e))}tryRecruitOrStackResources(e){return i(this,void 0,void 0,(function*(){try{yield this.lock.acquire({method:"tryRecruitOrStackResources",manager:"recruiter"}),d.default.getInstance().showInfo("Recruiter:","Rekrutacja/stakowanie surowców do rekrutacji"),yield e.city.switchAction(),yield this.performRecruitOrStackResources(e),this.tryCount=0}catch(t){console.warn("tryRecruitOrStackResources.catch:",t),this.tryCount++,this.tryCount<3&&this.performRecruitOrStackResources(e)}finally{d.default.getInstance().hideInfo(),this.lock.release()}}))}performRecruitOrStackResources(e){return i(this,void 0,void 0,(function*(){const t=e.queue[0];if(console.log("performRecruitOrStackResources:",t),!t)return console.log("no schedule item, clearing timeout and next scheduled time"),e.timeoutId&&clearTimeout(e.timeoutId),e.timeoutId=null,void(e.nextScheduledTime=null);const{city:n}=e,i=t.suppliersCities,r=yield this.resourceManager.getResourcesInfo();if("slots"===t.amountType){console.log("slots"),console.log("resourcesInfo before:",r);const o=.9*t.unitContextInfo.requiredResourcesPerSlot.wood-r.wood.amount,l=.9*t.unitContextInfo.requiredResourcesPerSlot.iron-r.iron.amount,a=.9*t.unitContextInfo.requiredResourcesPerSlot.stone-r.stone.amount,s=t.unitContextInfo.requiredResourcesPerSlot.population-r.population.amount;console.log("woodDiff:",o,"ironDiff:",l,"stoneDiff:",a,"populationDiff:",s);const c=o<0?0:Math.floor(o),u=l<0?0:Math.floor(l),d=a<0?0:Math.floor(a),h=s<0?0:s;if(console.log("woodAmountNeeded:",c,"ironAmountNeeded:",u,"stoneAmountNeeded:",d,"popuationAmountNeeded:",h),h>0)return console.log("popuationAmountNeeded > 0 - shifting queue"),void e.queue.shift();if(t.unitContextInfo.unitInfo.iron>r.storeMaxSize||t.unitContextInfo.unitInfo.wood>r.storeMaxSize||t.unitContextInfo.unitInfo.stone>r.storeMaxSize)return console.log("not enough storage capacity for unit, shifting queue"),void e.queue.shift();if([c,u,d].some((e=>e>0))){const r={target:{wood:Math.floor(.9*t.unitContextInfo.requiredResourcesPerSlot.wood),iron:Math.floor(.9*t.unitContextInfo.requiredResourcesPerSlot.iron),stone:Math.floor(.9*t.unitContextInfo.requiredResourcesPerSlot.stone)},toStack:{wood:c,iron:u,stone:d}};console.log("not enough resources, stacking:",r),yield this.closeAllRecruitmentBuildingDialogs();const o=yield this.stackResources(r,n,i,t.maxShipmentTime);if(o.fullyStacked){console.log("fully stacked, scheduling recruitment");const t=o.timeMs;e.timeoutId=this.createTimeoutForRecruitment(e,t),e.nextScheduledTime=(new Date).getTime()+t}else console.log("not fully stacked, scheduling in 10 minutes"),e.timeoutId=this.createTimeoutForRecruitment(e,6e5),e.nextScheduledTime=(new Date).getTime()+6e5,console.log("recruitment schedule updated:",e)}else console.log("enough resources, performing recruitment"),yield this.performRecruitment(e),console.log("recruitment performed, scheduling next recruitment"),yield this.performRecruitOrStackResources(e)}else{console.log("units");const o=t.unitContextInfo.unitInfo.wood*t.amountLeft-r.wood.amount,l=t.unitContextInfo.unitInfo.iron*t.amountLeft-r.iron.amount,a=t.unitContextInfo.unitInfo.stone*t.amountLeft-r.stone.amount;if(t.unitContextInfo.unitInfo.population*t.amountLeft-r.population.amount>0)return console.log("populationDiff > 0 - shifting queue"),void e.queue.shift();if(t.unitContextInfo.unitInfo.iron>r.storeMaxSize||t.unitContextInfo.unitInfo.wood>r.storeMaxSize||t.unitContextInfo.unitInfo.stone>r.storeMaxSize)return console.log("not enough storage capacity for unit, shifting queue"),void e.queue.shift();const s=Math.min(o<0?0:Math.floor(o),.9*r.storeMaxSize),c=Math.min(l<0?0:Math.floor(l),.9*r.storeMaxSize),u=Math.min(a<0?0:Math.floor(a),.9*r.storeMaxSize);if([s,c,u].some((e=>e>0))){const r={target:{wood:Math.floor(.9*t.unitContextInfo.unitInfo.wood),iron:Math.floor(.9*t.unitContextInfo.unitInfo.iron),stone:Math.floor(.9*t.unitContextInfo.unitInfo.stone)},toStack:{wood:s,iron:c,stone:u}};console.log("not enough resources, stacking:",r),yield this.closeAllRecruitmentBuildingDialogs();const o=yield this.stackResources(r,n,i,t.maxShipmentTime);if(o.fullyStacked){console.log("fully stacked, scheduling recruitment");const t=o.timeMs;e.timeoutId=this.createTimeoutForRecruitment(e,t),e.nextScheduledTime=(new Date).getTime()+t}else console.log("not fully stacked, scheduling in 10 minutes"),e.timeoutId=this.createTimeoutForRecruitment(e,6e5),e.nextScheduledTime=(new Date).getTime()+6e5,console.log("recruitment schedule updated:",e)}else console.log("enough resources, performing recruitment"),(yield this.performRecruitment(e))?(console.log("recruitment performed, scheduling next recruitment"),yield this.performRecruitOrStackResources(e)):(e.timeoutId=this.createTimeoutForRecruitment(e,6e5),e.nextScheduledTime=(new Date).getTime()+6e5,console.log("recruitment schedule updated:",e))}}))}performRecruitment(e){return i(this,void 0,void 0,(function*(){const t=e.queue[0];yield this.closeAllRecruitmentBuildingDialogs(),yield this.goToRecruitmentBuilding(t.type);const n=yield this.recruitUnits(t.unitContextInfo.unitSelector,"slots"===t.amountType?1/0:t.amountLeft);return console.log("slots"),t.amountLeft-="slots"===t.amountType?1:n,t.amountLeft<=0&&e.queue.shift(),console.log("amount left:",t.amountLeft),this.renderRecruitmentQueue(e.queue),this.closeAllRecruitmentBuildingDialogs(),n>0}))}cleanEventListeners(){this.eventListenersCleanupCallbacks.forEach((e=>e())),this.eventListenersCleanupCallbacks=[]}closeAllRecruitmentBuildingDialogs(){return i(this,void 0,void 0,(function*(){document.querySelectorAll(".minimized_windows_area .box-middle").forEach((e=>{var t,n,i;((null===(t=e.textContent)||void 0===t?void 0:t.includes("Port"))||(null===(n=e.textContent)||void 0===n?void 0:n.includes("Koszary")))&&(null===(i=e.querySelector(".btn_wnd.close"))||void 0===i||i.click())})),console.log("closeAllRecruitmentBuildingDialogs");let e=null;yield(0,a.waitUntil)((()=>!(e=document.querySelectorAll(".ui-dialog-titlebar-close")).length||!Array.from(e).some((e=>{var t,n;return null===(n=null===(t=e.parentElement)||void 0===t?void 0:t.nextSibling)||void 0===n?void 0:n.querySelector("#unit_order")}))),{onError:()=>{},maxIterations:3,delay:400}),e&&Array.from(e).filter((e=>{var t,n;return!!(null===(n=null===(t=e.parentElement)||void 0===t?void 0:t.nextSibling)||void 0===n?void 0:n.querySelector("#unit_order"))})).forEach((e=>e.click())),console.log("closeAllRecruitmentBuildingDialogs done")}))}recruitUnits(e,t){return i(this,void 0,void 0,(function*(){var n,i,r,o;let s=0;do{if(s++,null===(n=document.querySelector(e))||void 0===n||n.click(),yield(0,a.addDelay)(400),s>5)throw new l.InfoError("Unit cant get selectedd...",{})}while(!(null===(r=null===(i=document.querySelector(e))||void 0===i?void 0:i.parentElement)||void 0===r?void 0:r.classList.contains("unit_active")));const c=document.querySelector("#unit_order_input"),u=Number(c.value);let d=u;t!==1/0&&t<u?(d=t,c.value=t.toString()):c.value=u.toString(),yield(0,a.addDelay)(100);const h=document.querySelectorAll('[role="dialog"] .various_orders_background .empty_slot').length;return null===(o=document.getElementById("unit_order_confirm"))||void 0===o||o.click(),yield this.untilEmptySlotsAreEqual(h-1),d}))}untilEmptySlotsAreEqual(e){return i(this,void 0,void 0,(function*(){yield(0,a.waitUntil)((()=>document.querySelectorAll('[role="dialog"] .various_orders_background .empty_slot').length!==e))}))}goToRecruitmentBuilding(e){return i(this,void 0,void 0,(function*(){var t;null===(t=document.querySelector('[name="city_overview"]'))||void 0===t||t.click(),yield(0,c.waitForElementInterval)(`[data-building="${e}"]`).then((e=>e.click()))}))}createTimeoutForRecruitment(e,t){return console.log("createTimeoutForRecruitment:",t),setTimeout((()=>{this.tryRecruitOrStackResources(e)}),t)}stackResources(e,t,n,r){return i(this,void 0,void 0,(function*(){var i,o,l,s,u,d,h,m,g,f,p;console.log("stackResources",e);let v=-1;console.log("going to trade mode");const y=(0,a.shuffle)([...n]);yield this.goToTradeMode(t,y[0]);const b=Object.assign({},e.toStack);let[w,S,_]=null!==(o=null===(i=Array.from(document.querySelectorAll(".amounts")))||void 0===i?void 0:i.map((e=>{var t,n,i,r;return null===(r=null===(i=null===(n=null===(t=e.textContent)||void 0===t?void 0:t.match(/\d+ +\/ +\d+/))||void 0===n?void 0:n[0])||void 0===i?void 0:i.split("/"))||void 0===r?void 0:r.map((e=>Number(e)))})))&&void 0!==o?o:[];for(;2!==(null==w?void 0:w.length)||2!==(null==S?void 0:S.length)||2!==(null==_?void 0:_.length);)yield(0,a.addDelay)(400),[w,S,_]=null!==(s=null===(l=Array.from(document.querySelectorAll(".amounts")))||void 0===l?void 0:l.map((e=>{var t,n,i,r;return null===(r=null===(i=null===(n=null===(t=e.textContent)||void 0===t?void 0:t.match(/\d+ +\/ +\d+/))||void 0===n?void 0:n[0])||void 0===i?void 0:i.split("/"))||void 0===r?void 0:r.map((e=>Number(e)))})))&&void 0!==s?s:[];if(console.log("woodRealState:",w,"stoneRealState:",S,"ironRealState:",_),w[0]>=e.target.wood&&S[0]>=e.target.stone&&_[0]>=e.target.iron)return yield this.closeTradeMode(),{fullyStacked:!0,timeMs:3e5};let C="-1";for(const e of y){console.log("stacking resources from:",e.name);let t=!1,n=0,i=0;console.log("switching to without jumping:",e.name),yield e.switchAction(!1);let o=null,l=0;do{l++,yield(0,a.addDelay)(500),o=null===(u=document.querySelector("#duration_container .way_duration"))||void 0===u?void 0:u.textContent}while((!o||o===C)&&l<6);if(l>=6&&console.warn("stackResources.while.counter:",l),C=o,console.log("currentWayDurationText:",o),yield(0,a.addDelay)(333),n=(0,a.textToMs)(o.slice(1)),console.log("currentShipmentTimeMS:",n),console.log("maxShipmentTime:",r),n>r)continue;const s=yield this.resourceManager.getResourcesInfo();console.log("resources:",s),i=yield(0,c.waitForElementInterval)("#big_progressbar .curr").then((e=>Number(e.textContent))),console.log("currentTradeCapacity:",i);const[y,w,S]=null!==(h=null===(d=Array.from(document.querySelectorAll(".amounts")))||void 0===d?void 0:d.map((e=>{var t,n,i,r;return null===(r=null===(i=null===(n=null===(t=e.textContent)||void 0===t?void 0:t.match(/\d+ +\/ +\d+/))||void 0===n?void 0:n[0])||void 0===i?void 0:i.split("/"))||void 0===r?void 0:r.map((e=>Number(e)))})))&&void 0!==h?h:[];if(console.log("woodRealState:",y,"stoneRealState:",w,"ironRealState:",S),0!==b.iron&&(b.iron=S[0]+b.iron>=Math.floor(.9*S[1])?Math.max(100,Math.floor(.9*S[1])-S[0]):Math.max(100,b.iron)),0!==b.stone&&(b.stone=w[0]+b.stone>=Math.floor(.9*w[1])?Math.max(100,Math.floor(.9*w[1])-w[0]):Math.max(100,b.stone)),0!==b.wood&&(b.wood=y[0]+b.wood>=Math.floor(.9*y[1])?Math.max(100,Math.floor(.9*y[1])-y[0]):Math.max(100,b.wood)),console.log("stillNeededResources after checking:",b),b.wood>0&&i>=100&&s.wood.amount>=100){const e=yield(0,c.waitForElementInterval)("#trade_type_wood input",{interval:333,retries:4}),n=Math.min(b.wood,s.wood.amount,i);console.log("setting min wood value out of:",[b.wood,s.wood.amount,i]),e.value=n.toString(),b.wood-=n,i-=n,t=!0,console.log("remainning capacity:",i)}if(b.iron>0&&i>=100&&s.iron.amount>=100){const e=yield(0,c.waitForElementInterval)("#trade_type_iron input",{interval:333,retries:4}),n=Math.min(b.iron,s.iron.amount,i);console.log("setting min iron value out of:",[b.iron,s.iron.amount,i]),e.value=n.toString(),b.iron-=n,i-=n,t=!0,console.log("remainning capacity:",i)}if(b.stone>0&&i>=100&&s.stone.amount>=100){const e=yield(0,c.waitForElementInterval)("#trade_type_stone input",{interval:333,retries:4}),n=Math.min(b.stone,s.stone.amount,i);console.log("setting min stone value out of:",[b.stone,s.stone.amount,i]),e.value=n.toString(),b.stone-=n,i-=n,t=!0,console.log("remainning capacity:",i)}if(console.log(`-------------\nclicking trade button, while inputs values are: \n        woodInput:${null===(m=document.querySelector("#trade_type_wood input"))||void 0===m?void 0:m.value} \n        stoneInput:${null===(g=document.querySelector("#trade_type_stone input"))||void 0===g?void 0:g.value} \n        ironInput:${null===(f=document.querySelector("#trade_type_iron input"))||void 0===f?void 0:f.value}\n        capacity is: ${i}\n        stillNeededResources: ${JSON.stringify(b)}\n        `),t&&(null===(p=document.querySelector(".btn_trade_button.button_new"))||void 0===p||p.click()),n>v&&t&&(v=n),b.wood<=0&&b.iron<=0&&b.stone<=0)break}return yield this.closeTradeMode(),b.wood>0||b.iron>0||b.stone>0?(console.log("not fully stacked, timeMs:",v),{fullyStacked:!1,timeMs:v+3e3,resources:{toStack:b,target:e.target}}):(console.log("fully stacked, timeMs:",v),{fullyStacked:!0,timeMs:v+3e3})}))}closeTradeMode(){return i(this,void 0,void 0,(function*(){var e;yield(0,a.waitUntil)((()=>{var e,t;const n=document.querySelector(".ui-dialog-titlebar-close");return!n||!(null===(t=null===(e=n.parentElement)||void 0===e?void 0:e.nextSibling)||void 0===t?void 0:t.querySelector("#trade"))}),{delay:400,maxIterations:3,onError:()=>{}}),null===(e=document.querySelector(".ui-dialog-titlebar-close"))||void 0===e||e.click()}))}goToTradeMode(e,t){return i(this,void 0,void 0,(function*(){yield e.switchAction(),console.log("goToTradeMode, city:",e,"fromCity:",t);let n=0;do{n++,yield t.switchAction(!1),yield(0,c.performComplexClick)(document.querySelector(`#town_${e.cityId}`)).catch((()=>{console.log(`no town ${e.cityId} found`)})),yield(0,a.addDelay)(500)}while(!document.querySelector("#trading")&&n<5);if(n>=5)throw new l.InfoError("Couldn't click trading option",{});document.querySelector("#trading").click()}))}setDialogCurrentUnitImage(){const e=document.querySelector("#current-unit-image");null==e||e.setAttribute("class",this.currentUnitContext.unitImageClass)}setCurrentUnitContext(){return i(this,void 0,void 0,(function*(){var e,t,n,i,r,o,l,s,c,u;this.closeMinimizedRecruitmentBuildingDialogs();const d=document.getElementById("unit_order_unit_big_image"),h=null==d?void 0:d.classList.item(2),m="unit_icon50x50 "+h,g=Number(document.querySelectorAll('[role="dialog"] .various_orders_background .empty_slot').length),f=Number(null!==(t=null===(e=document.querySelector("#unit_order_unit_wood"))||void 0===e?void 0:e.textContent)&&void 0!==t?t:-1),p=Number(null!==(i=null===(n=document.querySelector("#unit_order_unit_stone"))||void 0===n?void 0:n.textContent)&&void 0!==i?i:-1),v=Number(null!==(o=null===(r=document.querySelector("#unit_order_unit_iron"))||void 0===r?void 0:r.textContent)&&void 0!==o?o:-1),y=Number(null!==(s=null===(l=document.querySelector("#unit_order_unit_pop"))||void 0===l?void 0:l.textContent)&&void 0!==s?s:-1),b=(0,a.textToMs)(null!==(u=null===(c=document.querySelector("#unit_order_unit_build_time"))||void 0===c?void 0:c.textContent)&&void 0!==u?u:"-1"),w=yield this.resourceManager.getStoreCapacity(),S=this.resourceManager.getPopulation(),_=`.unit_order_unit_image.${h}`,C=Math.floor(w/Math.max(f,p,v)),x={unitImageClass:m,unitSelector:_,emptySlotCount:g,unitInfo:{wood:f,stone:p,iron:v,population:y,recruitmentTime:b},requiredResourcesPerSlot:{wood:f*C,stone:p*C,iron:v*C,population:y*C},storeCapacity:w,populationCapacity:S};return this.currentUnitContext=x,console.log(this.currentUnitContext),x}))}populateCitiesSelect(e="barracks"){var t,n,i;const r=document.querySelector("#recruiter-cities");if(!r)return;const o=this.recruitmentSchedule.map((e=>e.city.name)),l=this.citySwitchManager.getCityList(),a=null===(n=null===(t=this.recruitmentSchedule.find((e=>{var t;return e.city.name===(null===(t=this.citySwitchManager.getCurrentCity())||void 0===t?void 0:t.name)})))||void 0===t?void 0:t.queue.at(-1))||void 0===n?void 0:n.suppliersCities;r.innerHTML="";for(const e of l){if(e.name===(null===(i=this.citySwitchManager.getCurrentCity())||void 0===i?void 0:i.name))continue;const t=document.createElement("option");t.value=e.name,t.textContent=e.name,o.includes(e.name)&&(t.disabled=!0),r.appendChild(t),(null==a?void 0:a.some((t=>t.name===e.name)))&&(t.selected=!0)}}getEmptySlotsCount(e){return Number(document.querySelectorAll(`.type_unit_queue.${e}`)[0].querySelectorAll(".empty_slot").length)}getCurrentUnitContextCopy(){return JSON.parse(JSON.stringify(this.currentUnitContext))}renderRecruitmentQueue(e){const t=document.getElementById("recruiter-queue-content");if(t){t.innerHTML="";for(const[n,i]of e.entries()){const r=document.createElement("div");r.classList.add("recruiter-queue-item");const o=document.createElement("div");o.setAttribute("class",i.unitContextInfo.unitImageClass),o.classList.add("recruiter-queue-item-image"),r.appendChild(o);const l=document.createElement("span");l.classList.add("recruiter-queue-item-info"),l.textContent=`${i.amount}x ${"slots"===i.amountType?"slots":"units"}`,r.appendChild(l);const a=document.createElement("button");a.setAttribute("type","button"),a.classList.add("recruiter-queue-item-delete-btn"),a.textContent="x",r.appendChild(a);const s=()=>{e.splice(n,1),a.removeEventListener("click",s),this.renderRecruitmentQueue(e)};a.addEventListener("click",s),t.appendChild(r)}}}closeMinimizedRecruitmentBuildingDialogs(){document.querySelectorAll(".minimized_windows_area .box-middle").forEach((e=>{var t,n,i;((null===(t=e.textContent)||void 0===t?void 0:t.includes("Port"))||(null===(n=e.textContent)||void 0===n?void 0:n.includes("Koszary")))&&(null===(i=e.querySelector(".btn_wnd.close"))||void 0===i||i.click())}))}}p.MAX_DELIVERY_TIME_MS=15e5,t.default=p},254:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function l(e){try{s(i.next(e))}catch(e){o(e)}}function a(e){try{s(i.throw(e))}catch(e){o(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(l,a)}s((i=i.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=r(n(639)),l=n(910),a=r(n(785)),s=n(396),c=r(n(2));class u{constructor(){var e,t,n,i,r,l;this.configManager=o.default.getInstance(),this.minPopulationBuffer=null!==(n=null===(t=null===(e=this.configManager.getConfig())||void 0===e?void 0:e.resources)||void 0===t?void 0:t.minPopulationBuffer)&&void 0!==n?n:100,this.storeAlmostFullPercentage=null!==(l=null===(r=null===(i=this.configManager.getConfig())||void 0===i?void 0:i.resources)||void 0===r?void 0:r.storeAlmostFullPercentage)&&void 0!==l?l:.9}static getInstance(){return i(this,void 0,void 0,(function*(){return u.instance||(u.instance=new u,u.instance.lock=a.default.getInstance(),u.instance.citySwitchManager=yield c.default.getInstance()),this.instance}))}start(){return i(this,void 0,void 0,(function*(){}))}stop(){}getStoreCapacity(){return i(this,void 0,void 0,(function*(){var e;const t=yield(0,s.waitForElement)('[data-type="wood"] .amount.ui-game-selectable');let n=null;do{(0,s.triggerHover)(t),yield(0,l.addDelay)(333)}while(!(n=document.querySelector(".island_resource_info span:nth-of-type(2)")));const i=n.textContent,r=parseInt((null===(e=null==i?void 0:i.match(/\d+/))||void 0===e?void 0:e[0])||"0");return(0,s.cancelHover)(t),r}))}getPopulation(){return Number(document.querySelector('[data-type="population"] .amount.ui-game-selectable').textContent)}getResourcesInfo(){return i(this,void 0,void 0,(function*(){var e;const t=Number((yield(0,s.waitForElement)('[data-type="wood"] .amount.ui-game-selectable')).textContent),n=Number((yield(0,s.waitForElement)('[data-type="stone"] .amount.ui-game-selectable')).textContent),i=Number((yield(0,s.waitForElement)('[data-type="iron"] .amount.ui-game-selectable')).textContent),r=Number((yield(0,s.waitForElement)('[data-type="population"] .amount.ui-game-selectable')).textContent),o=yield(0,s.waitForElement)('[data-type="wood"] .amount.ui-game-selectable');let a=null;do{(0,s.triggerHover)(o),yield(0,l.addDelay)(333)}while(!(a=document.querySelector(".island_resource_info span:nth-of-type(2)")));const c=a.textContent,u=parseInt((null===(e=null==c?void 0:c.match(/\d+/))||void 0===e?void 0:e[0])||"0");return(0,s.cancelHover)(o),{wood:{amount:t,isAlmostFull:t>this.storeAlmostFullPercentage*u,isFull:t===u},stone:{amount:n,isAlmostFull:n>this.storeAlmostFullPercentage*u,isFull:n===u},iron:{amount:i,isAlmostFull:i>this.storeAlmostFullPercentage*u,isFull:i===u},population:{amount:r,isLow:r<this.minPopulationBuffer},storeMaxSize:u}}))}hasEnoughResources(e,t){return i(this,void 0,void 0,(function*(){yield t.switchAction();const n=Number(document.querySelector('[data-type="wood"] .amount.ui-game-selectable').textContent),i=Number(document.querySelector('[data-type="stone"] .amount.ui-game-selectable').textContent),r=Number(document.querySelector('[data-type="iron"] .amount.ui-game-selectable').textContent);return n>=e.wood&&i>=e.stone&&r>=e.iron}))}}t.default=u},567:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function l(e){try{s(i.next(e))}catch(e){o(e)}}function a(e){try{s(i.throw(e))}catch(e){o(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(l,a)}s((i=i.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=r(n(639)),l=n(388),a=n(910),s=r(n(785)),c=n(396),u=r(n(641)),d=r(n(2)),h=r(n(299)),m=r(n(715)),g=r(n(813)),f=r(n(846)),p=r(n(218));var v;!function(e){e[e.ARMY_ATTACK=0]="ARMY_ATTACK",e[e.ARMY_SUPPORT=1]="ARMY_SUPPORT",e[e.ARMY_WITHDRAW=2]="ARMY_WITHDRAW",e[e.RESOURCE_SHIPMENT=3]="RESOURCE_SHIPMENT"}(v||(v={}));class y{constructor(){this.isLockTakenByScheduler=!1,this.scheduler=[],this._error=null,this._hydrationError=null,this._info=null,this.RUN=!0}privateconstructor(){}static getInstance(){return i(this,void 0,void 0,(function*(){return y.instance||(y.instance=new y,y.instance.lock=s.default.getInstance(),y.instance.generalInfo=m.default.getInstance(),y.instance.armyMovement=u.default.getInstance(),y.instance.masterManager=yield h.default.getInstance(),y.instance.citySwitchManager=yield d.default.getInstance(),y.instance.config=o.default.getInstance().getConfig(),y.instance.addUIExtenstion(),y.instance.addSchedulerListConfigWindow(),y.instance.synchronizeSchedulerWithStorage()),y.instance}))}addUIExtenstion(){return i(this,void 0,void 0,(function*(){yield this.mountCityDialogObserver()}))}run(){return i(this,void 0,void 0,(function*(){this.RUN=!0}))}stop(){return i(this,void 0,void 0,(function*(){this.RUN=!1}))}isRunning(){return this.RUN}undoArmyMovement(e,t){return i(this,void 0,void 0,(function*(){var n;yield e.switchAction(),yield(0,a.addDelay)(100);const i=document.querySelector("#toolbar_activity_commands");(0,c.triggerHover)(i),null===(n=document.querySelector(`#${t}`))||void 0===n||n.click()}))}extendAttackSupportUI(e){return i(this,void 0,void 0,(function*(){const t=e.querySelector(".button_wrapper"),n=document.createElement("div");n.innerHTML=g.default,t.appendChild(n);const r=document.querySelector("#schedule-date");r.value=this.getFormattedInputValueFromDate(new Date),n.querySelector("#schedule-button").addEventListener("click",(()=>i(this,void 0,void 0,(function*(){var t,n,o;this.error=null;const l=e.querySelector(".way_duration").textContent.slice(1),s=(0,a.textToMs)(l),u=Array.from(e.querySelectorAll(".unit_input")).map((e=>({name:e.getAttribute("name"),value:e.value}))),d=null===(t=e.querySelector(".cbx_include_hero"))||void 0===t?void 0:t.classList.contains("checked"),h="attack"===e.firstElementChild.getAttribute("data-type")?v.ARMY_ATTACK:v.ARMY_SUPPORT,m=h===v.ARMY_ATTACK?`[data-attack='${null===(n=document.querySelector(".attack_type.checked"))||void 0===n?void 0:n.dataset.attack}']`:void 0,g=document.querySelectorAll(".attack_strategy.checked"),f=Array.from(g).at(-1),p=f?`#${null==f?void 0:f.id}`:void 0,y=document.querySelector(".spells.power.power_icon45x45");let b=null;(null==y?void 0:y.classList.contains("no_power"))||(b=`[data-power_id='${null==y?void 0:y.classList.item(3)}']`);const w=r.value,S=document.querySelector("#schedule-time").value,_=this.getDateFromDateTimeInputValues(w,S),C=new Date(_.getTime()-s),x=this.citySwitchManager.getCurrentCity(),k="#town_"+Array.from(e.classList).find((e=>e.match(/attack_support_tab_target_\d+/))).match(/\d+/)[0];if(!this.canAddSchedulerItem(C))return console.warn("unsafe operation, failed to be scheudled"),void(this.error="Schedule failed. Cannot safely schedule operation.");if(!u.some((e=>e.value)))return void(this.error="Schedule failed. All units are empty.");document.querySelector('[data-menu_name="Info"]').click(),yield(0,a.addDelay)(100);const I=yield(0,c.waitForElementInterval)("#towninfo_towninfo .game_header.bold",{interval:500,timeout:2e3}).then((e=>e.textContent.trim())),E=`${h}_${x.name}_${I}_${C.getTime()}`;yield(0,c.waitForElementInterval)(".info_jump_to_town",{interval:500,retries:3}).then((e=>e.click())).catch((()=>{this.error="Schedule failed. Failed to switch to the city for grids."})),(yield(0,c.waitForElements)(".minimized_windows_area .btn_wnd.close",2e3)).forEach((e=>e.click())),yield(0,a.addDelay)(500),null===(o=document.querySelector(".btn_save_location"))||void 0===o||o.click(),yield(0,a.addDelay)(100),yield(0,c.waitForElement)(".save_coordinates input",4e3).then((e=>{(0,c.setInputValue)(e,E),e.blur()})).catch((()=>{throw new Error("Failed to save coordinates")})),yield(0,a.addDelay)(100),yield(0,c.waitForElement)(".save_coordinates .btn_confirm",3e3).then((e=>e.click())).catch((()=>{throw new Error("Failed to confirm saving coordinates")}));const T={id:E,operationType:h,attackTypeSelector:m,attackStrategySelector:p,powerSelector:b,targetDate:_,targetCityName:I,actionDate:C,realActionTime:C.getTime()+this.config.general.timeDifference,sourceCity:x,targetCitySelector:k,data:u,includeHero:d,timeoutStructure:{timeoutPreparation:null,timeoutPreAction:null,timeoutAction:null},movementId:null,undoMovementAction:null,cancelSchedule:()=>i(this,void 0,void 0,(function*(){return yield this.cancelSchedule(T)})),postActionCleanup:()=>i(this,void 0,void 0,(function*(){return yield this.postActionCleanup(T)}))};this.addActionTimeouts(T),this.scheduler.push(T),this.addSchedulerItemToUI(T),localStorage.setItem("scheduler",JSON.stringify(this.scheduler)),this.info="Operation scheduled",console.log("Scheduler.extendAttackSupportUI.schedulerItem",T)}))))}))}postActionCleanup(e){return i(this,void 0,void 0,(function*(){setTimeout((()=>{this.removeSchedulerItemFromUI(e),this.scheduler=this.scheduler.filter((t=>t!==e)),localStorage.setItem("scheduler",JSON.stringify(this.scheduler))}),0),this.isLockTakenByScheduler&&this.lock.release(),this.isLockTakenByScheduler=!1,this.generalInfo.showInfo("Scheduler:","Czyszczenie cache po operacji."),yield this.removeSavedCoords(e.id),this.generalInfo.hideInfo(),this.tryRestoreManagers()}))}cancelSchedule(e){return i(this,void 0,void 0,(function*(){this.generalInfo.showInfo("Scheduler:","Anulowanie operacji.");const{timeoutStructure:t}=e;t.timeoutPreparation&&clearTimeout(t.timeoutPreparation),t.timeoutPreAction&&clearTimeout(t.timeoutPreAction),t.timeoutAction&&clearTimeout(t.timeoutAction),this.isLockTakenByScheduler&&(this.lock.release(),this.isLockTakenByScheduler=!1),this.scheduler=this.scheduler.filter((t=>t!==e)),localStorage.setItem("scheduler",JSON.stringify(this.scheduler)),this.removeSchedulerItemFromUI(e),yield this.removeSavedCoords(e.id),this.generalInfo.hideInfo(),this.tryRestoreManagers()}))}removeSavedCoords(e){return i(this,void 0,void 0,(function*(){var t,n;null===(n=null===(t=Array.from(document.querySelectorAll(".content.js-dropdown-item-list .item.bookmark")).find((t=>{var n;return(null===(n=t.textContent)||void 0===n?void 0:n.trim())===e})))||void 0===t?void 0:t.querySelector(".remove"))||void 0===n||n.click(),yield(0,c.waitForElementInterval)(".confirmation .btn_confirm",{interval:500,timeout:2e3}).then((e=>e.click()))}))}readCords(){const e=document.querySelector('.coord.coord_x.js-coord-x input[type="text"]'),t=document.querySelector('.coord.coord_y.js-coord-y input[type="text"]');return[e.value,t.value]}addActionTimeouts(e){const{actionDate:t,realActionTime:n,timeoutStructure:r,targetCitySelector:o,data:s,operationType:u,attackTypeSelector:d,attackStrategySelector:h,powerSelector:m}=e,g=n-(new Date).getTime()-y.TURN_OFF_MANAGERS_TIME_MS;r.timeoutPreparation=setTimeout((()=>{this.generalInfo.showInfo("Scheduler:","pauzowanie kolidujących managerów przed operacją."),this.masterManager.pauseRunningManagersIfNeeded(n,["scheduler"]);const t=n-(new Date).getTime()-y.PREPARATION_TIME_MS;r.timeoutPreAction=setTimeout((()=>i(this,void 0,void 0,(function*(){var t,g;try{yield this.lock.forceAcquire({manager:"scheduler"}),this.isLockTakenByScheduler=!0,this.generalInfo.showInfo("Scheduler:","przygotowanie do operacji."),yield e.sourceCity.switchAction(),null===(t=document.querySelector(".js-coord-button"))||void 0===t||t.click();const n=yield(0,c.waitForElement)(".content.js-dropdown-item-list",4e3),i=Array.from(n.querySelectorAll(".item.bookmark.option")).find((t=>{var n;return(null===(n=t.textContent)||void 0===n?void 0:n.trim())===e.id}));if(!i)throw new Error("Failed to find dropdown item");i.click(),yield(0,a.addDelay)(400),null===(g=document.querySelector(".ui-dialog-titlebar-close"))||void 0===g||g.click();const r=yield(0,c.waitForElementInterval)(o,{interval:500,retries:4}).catch((()=>{throw new l.InfoError("target city not found",{browserState:(0,a.getBrowserStateSnapshot)()})})),f=(0,a.getElementStateSnapshot)(r);let p=0;do{yield(0,c.performComplexClick)(r),p++,yield(0,a.addDelay)(333)}while(!document.querySelector("#context_menu")&&p<4);if(4===p){const e={browserState:(0,a.getBrowserStateSnapshot)(),elementState:f};throw new l.InfoError("target city not found",e)}u===v.ARMY_ATTACK?(console.log("operationType === OperationType.ARMY_ATTACK"),(yield(0,c.waitForElementInterval)("#attack",{interval:500,timeout:2e3})).click(),console.log("attack clicked",document.querySelector("#attack")),d&&(yield(0,c.waitForElementInterval)(d,{interval:500,timeout:2e3}).then((e=>e.click()))),console.log("attackTypeSelector clicked",document.querySelector(d)),h&&(yield(0,c.waitForElementInterval)(h,{interval:500,timeout:2e3}).then((e=>e.click()))),console.log("attackStrategySelector clicked",document.querySelector(h)),m?(console.log("powerSelector",m),yield(0,c.waitForElementInterval)("#spells_1",{interval:500,timeout:2e3}).then((e=>e.click())),console.log("spells_1",document.querySelector("#spells_1")),yield(0,c.waitForElementInterval)(m,{interval:500,timeout:2e3}).then((e=>e.click())),console.log("powerSelector",document.querySelector(m))):console.log("no powerSelector")):(yield(0,c.waitForElementInterval)("#support",{interval:500,timeout:2e3})).click(),console.log("fill inputData");for(const e of s)if(e.value){const t=yield(0,c.waitForElementInterval)(`input[name="${e.name}"]`,{interval:500,timeout:2e3});(0,c.setInputValue)(t,e.value),t.blur()}e.includeHero&&(console.log("should include hero"),(yield(0,c.waitForElementInterval)(".cbx_include_hero")).click()),console.log("action prepared successfully, snapshot:",{browserState:(0,a.getBrowserStateSnapshot)(),elementState:f})}catch(t){return t instanceof l.InfoError?console.warn("Error during 10 seconds before action:",t.message,t.details):console.error("Error during 10 seconds before action:",t),this.error="Schedule failed. Check console for more details.",this.generalInfo.hideInfo(),void e.cancelSchedule()}r.timeoutAction=setTimeout((()=>i(this,void 0,void 0,(function*(){var t;try{u===v.ARMY_ATTACK?((yield(0,c.waitForElement)("#btn_attack_town")).click(),yield(0,c.waitForElement)(".js-window-main-container.classic_window.dialog .btn_confirm.button_new",1e3).then((e=>e.click())).catch((()=>{}))):(yield(0,c.waitForElement)(".attack_support_window a .middle")).click(),this.armyMovement.setCallback((t=>{e.movementId=t,e.undoMovementAction=()=>this.undoArmyMovement(e.sourceCity,t)})),null===(t=document.querySelector(".ui-dialog-titlebar-close"))||void 0===t||t.click(),this.error=null}catch(t){e.cancelSchedule(),console.error("Error during action:",t),this.error="Schedule failed. Check console for more details."}finally{e.postActionCleanup()}}))),n-(new Date).getTime())}))),t)}),g)}goToCoords(e){const t=document.querySelector('.coord.coord_x.js-coord-x input[type="text"]'),n=document.querySelector('.coord.coord_y.js-coord-y input[type="text"]');(0,c.setInputValue)(t,e[0]),(0,c.setInputValue)(n,e[1]),document.querySelector(".btn_jump_to_coordination").click()}synchronizeSchedulerWithStorage(){JSON.parse(localStorage.getItem("scheduler")||"[]").forEach((e=>this.hydrateSchedulerItem(e))),this.handleIfSchedulerListIsEmpty()}hydrateSchedulerItem(e){if(e.operationType===v.ARMY_ATTACK||e.operationType===v.ARMY_SUPPORT){if(e.actionDate=new Date(e.actionDate),e.targetDate=new Date(e.targetDate),e.sourceCity=this.citySwitchManager.getCityByName(e.sourceCity.name),!this.canAddSchedulerItem(e.actionDate))return console.warn("unsafe operation, failed to be scheudled during hydration"),void(this.hydrationError=`${e.sourceCity.name} ${e.operationType===v.ARMY_ATTACK?"attack":"support"} operation  at '${e.targetDate}' on city "${e.targetCitySelector}" failed to be scheduled during hydration.`);e.cancelSchedule=()=>i(this,void 0,void 0,(function*(){return yield this.cancelSchedule(e)})),e.postActionCleanup=()=>i(this,void 0,void 0,(function*(){return yield this.postActionCleanup(e)})),this.addActionTimeouts(e),this.scheduler.push(e),this.addSchedulerItemToUI(e)}}set error(e){const t=document.querySelector("#schedule-error");e?t&&(t.textContent=e):t&&(t.textContent=""),this._error=e}set hydrationError(e){this._hydrationError=e}set info(e){const t=document.querySelector("#schedule-info");e?t&&(t.textContent=e,setTimeout((()=>{t.textContent=""}),4e3)):t&&(t.textContent=""),this._info=e}canAddSchedulerItem(e){return e.getTime()-(new Date).getTime()>1e4&&(0===this.scheduler.length||!this.scheduler.some((t=>Math.abs(t.actionDate.getTime()-e.getTime())<1e4?(console.log("Interlacing times:",t.actionDate,e),console.log("\t:",t.actionDate.getTime()-e.getTime(),(t.actionDate.getTime()-e.getTime())/1e3),!0):(console.log("Not interlacing times:",t.actionDate,e),!1))))}tryRestoreManagers(){if(0===this.scheduler.length)console.log("RESTORE MANAGERS"),this.masterManager.resumeRunningManagers(["scheduler"]);else{const e=new Date,t=this.scheduler.reduce(((t,n)=>n.actionDate<e||t&&t<n.actionDate?t:n.actionDate),null);if(t)return void(t.getTime()-(new Date).getTime()>6e4?(console.log("RESTORE MANAGERS"),this.masterManager.resumeRunningManagers(["scheduler"])):console.log("DO NOT RESTORE MANAGERS"));this.masterManager.resumeRunningManagers(["scheduler"])}}getDateFromDateTimeInputValues(e,t){const n=t.match(/(\d{2})\D*(\d{2})\D*(\d{2})/);if(!n||!e.match(/^\d{4}-\d{2}-\d{2}$/))throw new Error("Invalid time format");const[,i,r,o]=n;return new Date(`${e}T${i}:${r}:${o}`)}getFormattedInputValueFromDate(e){return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}mountAttackSupportSubpageObserver(e){const t=new MutationObserver((e=>{for(const t of e)if("childList"===t.type)for(const e of t.addedNodes)if(e.nodeType===Node.ELEMENT_NODE&&e.classList.contains("attack_support_window"))return void this.extendAttackSupportUI(e)}));return t.observe(e,{childList:!0,subtree:!0}),()=>t.disconnect()}mountCityDialogObserver(){return i(this,void 0,void 0,(function*(){let e=null;new MutationObserver((t=>{for(const n of t)if("childList"===n.type){for(const t of n.addedNodes)if(t.nodeType===Node.ELEMENT_NODE&&"ui-dialog ui-corner-all ui-widget ui-widget-content ui-front ui-draggable ui-resizable js-window-main-container"===t.getAttribute("class"))return void(e=this.mountAttackSupportSubpageObserver(t));for(const t of n.removedNodes)if(t.nodeType===Node.ELEMENT_NODE&&"dialog"===t.getAttribute("role")&&t.classList.contains("ui-dialog")&&t.classList.contains("js-window-main-container")&&e)return e(),void(e=null)}})).observe(document.body,{childList:!0})}))}addSchedulerListConfigWindow(){const e=document.createElement("style");e.textContent=p.default,document.head.appendChild(e);const t=document.createElement("div");t.innerHTML=f.default,document.body.appendChild(t),this.addSchedulerListConfigListeners()}addSchedulerListConfigListeners(){const e=document.querySelector("#scheduler-toggle-button"),t=document.querySelector("#table-container");null==e||e.addEventListener("click",(()=>{null==t||t.classList.toggle("hidden")}));const n=document.querySelector(".close-icon");null==n||n.addEventListener("click",(()=>{null==t||t.classList.add("hidden")}))}addSchedulerItemToUI(e){const t=document.querySelector("#scheduler-lookup-table tbody").insertRow(),n=this.getSchedulerItemId(e);t.setAttribute("data-scheduler-item-id",n);const i=t.insertCell();i.textContent=e.operationType===v.ARMY_ATTACK?"Attack":"Support",i.classList.add(e.operationType===v.ARMY_ATTACK?"attack":"support"),t.insertCell().textContent=e.sourceCity.name,t.insertCell().textContent=e.targetCityName,t.insertCell().textContent=e.actionDate.toLocaleTimeString(),t.insertCell().textContent=e.targetDate.toLocaleTimeString();const r=t.insertCell(),o=document.createElement("button");o.classList.add("cancel-button"),o.textContent="Cancel",o.addEventListener("click",(()=>{e.cancelSchedule(),this.removeSchedulerItemFromUI(e)})),r.appendChild(o),this.handleIfSchedulerListIsEmpty()}removeSchedulerItemFromUI(e){console.log("removeSchedulerItemFromUI",e);const t=document.querySelector("#scheduler-lookup-table tbody").querySelector(`[data-scheduler-item-id="${this.getSchedulerItemId(e)}"]`);null==t||t.remove(),this.handleIfSchedulerListIsEmpty()}getSchedulerItemId(e){return`${e.operationType}_${e.sourceCity.name}_${e.targetCityName}_${e.actionDate.getTime()}`}handleIfSchedulerListIsEmpty(){const e=document.querySelector("#no-schedules");0===this.scheduler.length?e.classList.remove("hidden"):e.classList.add("hidden")}canSafelyRefresh(){return 0===this.scheduler.length||this.scheduler.every((e=>e.actionDate>new Date((new Date).getTime()+12e4)))}}y.MIN_PRECEDENCE_TIME_MS=1e4,y.TURN_OFF_MANAGERS_TIME_MS=2e4,y.PREPARATION_TIME_MS=1e4,t.default=y},639:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function l(e){try{s(i.next(e))}catch(e){o(e)}}function a(e){try{s(i.throw(e))}catch(e){o(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(l,a)}s((i=i.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=r(n(773)),l=n(910),a=r(n(16));class s{constructor(){}static getInstance(){return s.instance||(s.instance=new s,s.instance.storageManager=a.default.getInstance(),s.instance.config=s.instance.initConfig(),s.instance.setTimeDifference()),s.instance}setTimeDifference(){return i(this,void 0,void 0,(function*(){let e=document.querySelector(".server_time_area").textContent.split(" ")[0];for(;!e.match(/\d{2}:\d{2}:\d{2}/);)yield(0,l.addDelay)(400),e=document.querySelector(".server_time_area").textContent.split(" ")[0];let t=e.split(":"),n=new Date;n.setHours(parseInt(t[0])),n.setMinutes(parseInt(t[1])),n.setSeconds(parseInt(t[2])),this.config.general.timeDifference=(new Date).getTime()-n.getTime(),console.log(`server time: ${n}\nreal time: ${new Date}\ndiff in [s]: ${this.config.general.timeDifference/1e3}`)}))}initConfig(){const e=this.storageManager.readFromLocalStorage("config");return e&&this.isConfigStructureEqual(e,o.default,["farmingCities"])?e:(this.storageManager.writeToLocalStorage("config",o.default),o.default)}isConfigStructureEqual(e,t,n=[]){return Object.keys(e).length===Object.keys(t).length&&Object.keys(e).every((i=>i in t&&(n.includes(i)||"object"!=typeof e[i]||null===e[i]?typeof e[i]==typeof t[i]:this.isConfigStructureEqual(e[i],t[i],n))))}getConfig(){return this.config}persistConfig(){this.storageManager.writeToLocalStorage("config",this.config)}getConfigValue(e){return this.config[e]}}t.default=s},388:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.InfoError=void 0;class n extends Error{constructor(e,t){super(e),this.details=t,this.name="InfoError"}}t.InfoError=n},910:function(e,t){var n=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function l(e){try{s(i.next(e))}catch(e){o(e)}}function a(e){try{s(i.throw(e))}catch(e){o(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(l,a)}s((i=i.apply(e,t||[])).next())}))};function i(e,i){return n(this,arguments,void 0,(function*(e,n,i={}){const r={delay:void 0!==i.delay?i.delay:400,maxIterations:void 0!==i.maxIterations?i.maxIterations:5,onError:i.onError};let o=0;for(;(yield e())&&o<r.maxIterations;)n&&(yield n()),yield(0,t.addDelay)(r.delay),o++;if(o>=r.maxIterations){if(!r.onError)throw new Error("Max iterations reached");r.onError(new Error("Max iterations reached"))}}))}Object.defineProperty(t,"__esModule",{value:!0}),t.hasAnyValue=t.getElementStateSnapshot=t.getBrowserStateSnapshot=t.getCopyOf=t.getRandomMs=t.areGridsEqual=t.msToTimeString=t.formatDateToSimpleString=t.getTimeInFuture=t.addDelay=t.isVisible=t.textToMs=void 0,t.getRandomInt=function(e){return Math.floor(Math.random()*e)},t.areArraysContentsEqual=function(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0},t.shuffleArray=function(e){for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}},t.isMobile=function(){return navigator.userAgentData?navigator.userAgentData.mobile:!!(navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/Android/i))},t.calculateTimeToNextOccurrence=function(e){console.log("timeString to calculate: ",e);const[t,n,i]=e.split(":").map(Number),r=new Date,o=new Date(r);return o.setHours(t,n,i,0),o<=r&&o.setDate(o.getDate()+1),o.getTime()-r.getTime()},t.getCookie=function(e){const t=document.cookie.split("; ");for(let n of t){const[t,i]=n.split("=");if(t===e)return JSON.parse(decodeURIComponent(i))}return null},t.setCookie=function(e,t,n={}){const{expires:i=new Date(Date.now()+864e5),path:r="/",domain:o=".grepolis.com",secure:l=!1,sameSite:a="Lax"}=n;let s=`${e}=${encodeURIComponent(JSON.stringify(t))}; path=${r}; SameSite=${a}`;i&&(s+=`; expires=${i.toUTCString()}`),o&&(s+=`; domain=${o}`),l&&(s+="; secure"),document.cookie=s},t.shuffle=function(e){for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}return e},t.doUntil=i,t.waitUntil=function(e,t={}){const n=400,r=5;return i(e,null,{delay:void 0!==t.delay?t.delay:n,maxIterations:void 0!==t.maxIterations?t.maxIterations:r,onError:t.onError})},t.textToMs=e=>{const t=e.split(":").map((e=>parseInt(e)));return 1e3*t[0]*60*60+1e3*t[1]*60+1e3*t[2]},t.isVisible=e=>e.offsetParent,t.addDelay=(e=1e3)=>new Promise((t=>setTimeout(t,e))),t.getTimeInFuture=e=>{const t=new Date,n=new Date(t.getTime()+e);return`${n.getHours().toString().padStart(2,"0")}:${n.getMinutes().toString().padStart(2,"0")}:${n.getSeconds().toString().padStart(2,"0")}`},t.formatDateToSimpleString=e=>`${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}:${e.getSeconds().toString().padStart(2,"0")}`,t.msToTimeString=e=>{const t=Math.floor(e/36e5),n=Math.floor(e%36e5/6e4),i=Math.floor(e%6e4/1e3);return`${t.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`},t.areGridsEqual=(e,t)=>e[0]===t[0]&&e[1]===t[1],t.getRandomMs=(e,t)=>Math.floor(Math.random()*(t-e+1)+e),t.getCopyOf=e=>JSON.parse(JSON.stringify(e)),t.getBrowserStateSnapshot=()=>({documentVisibility:document.visibilityState,windowFocus:document.hasFocus(),windowSize:{width:window.innerWidth,height:window.innerHeight}}),t.getElementStateSnapshot=e=>({elementVisibility:null!==e.offsetParent,elementPosition:e.getBoundingClientRect(),elementZIndex:window.getComputedStyle(e).zIndex,elementInViewport:e.getBoundingClientRect().top>=0&&e.getBoundingClientRect().bottom<=window.innerHeight,elementClickable:!!e.onclick}),t.hasAnyValue=(e,n)=>{for(const i of Object.values(e))if("object"==typeof i&&null!==i){if((0,t.hasAnyValue)(i,n))return!0}else if(i===n)return!0;return!1}},16:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0});class n{constructor(){}static getInstance(){return n.instance||(n.instance=new n),n.instance}readFromLocalStorage(e){const t=localStorage.getItem(e);return t?JSON.parse(t):null}writeToLocalStorage(e,t){localStorage.setItem(e,JSON.stringify(t))}}t.default=n},785:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function l(e){try{s(i.next(e))}catch(e){o(e)}}function a(e){try{s(i.throw(e))}catch(e){o(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(l,a)}s((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const r=n(910);class o{constructor(){this.lockQueueInfo=[],this.lockCheckInterval=null,this.isLocked=!1,this.queue=[]}static getInstance(){return this.instance||(this.instance=new o,this.instance.setLockCheckInterval()),this.instance}setLockCheckInterval(){this.lockCheckInterval=setInterval((()=>{this.isLocked&&Date.now()-this.isLocked.requestedAt.getTime()>o.LOCK_TIMEOUT&&(console.warn(`Lock: lock is taken for too long by ${this.isLocked.manager} "${this.isLocked.method}", releasing...`),this.release())}),o.LOCK_TIMEOUT)}acquire(e){return i(this,void 0,void 0,(function*(){const t={method:null==e?void 0:e.method,requestedAt:new Date,forced:!1,manager:null==e?void 0:e.manager};this.isLocked?(console.log("\t-lock is taken, add",this.mapToLogObj(t),"to queue:",(0,r.getCopyOf)(this.lockQueueInfo)),this.lockQueueInfo.push(t),yield new Promise((e=>{this.queue.push(e)}))):(t.acquiredAt=new Date,this.isLocked=t,console.log("Lock: acquire",this.mapToLogObj(this.isLocked)))}))}forceAcquire(e){return i(this,void 0,void 0,(function*(){const t={method:e.method,requestedAt:new Date,forced:!0,manager:e.manager};if(!this.isLocked)return t.acquiredAt=new Date,this.isLocked=t,void console.log("Lock: forceAcquire: ",this.mapToLogObj(t));console.log("Lock: forceAcquire by",this.mapToLogObj(t),"on current lock:",this.mapToLogObj(this.isLocked)),yield new Promise((e=>{this.lockQueueInfo.unshift(t),this.queue.unshift(e),this.release()}))}))}release(){var e;if(this.queue.length>0){const t=this.queue.shift();t&&(this.isLocked.releasedAt=new Date,console.log("Lock: release:",this.mapToLogObj(this.isLocked)),this.isLocked=null!==(e=this.lockQueueInfo.shift())&&void 0!==e?e:{},this.isLocked.acquiredAt=new Date,console.log("\t-next element in the queue takes the lock:",this.mapToLogObj(this.isLocked)),t())}else this.isLocked.releasedAt=new Date,console.log("Lock: release: ",this.mapToLogObj(this.isLocked)),this.isLocked=!1}mapToLogObj(e){const t=Object.assign({},e);return t.requestedAt=t.requestedAt.toLocaleString(),t.acquiredAt&&(t.acquiredAt=t.acquiredAt.toLocaleString()),t.releasedAt&&(t.releasedAt=t.releasedAt.toLocaleString()),(0,r.getCopyOf)(t)}isTaken(){return!!this.isLocked}}o.LOCK_TIMEOUT=3e5,o.instance=null,t.default=o},396:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function l(e){try{s(i.next(e))}catch(e){o(e)}}function a(e){try{s(i.throw(e))}catch(e){o(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(l,a)}s((i=i.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.cancelHover=t.triggerHover=void 0,t.simulateClick=function(e){if(e){const t=e.getBoundingClientRect(),n=new MouseEvent("click",{clientX:t.left+t.width/2,clientY:t.top+t.height/2,bubbles:!0,cancelable:!0,view:window});e.dispatchEvent(n)}},t.setInputValue=function(e,t){if(e&&"INPUT"===e.tagName){e.value="number"==typeof t?t.toString():t;const n=new Event("input",{bubbles:!0});e.dispatchEvent(n);const i=new Event("change",{bubbles:!0});e.dispatchEvent(i)}else console.warn(`setInputValue(${e.name}) unsuccessful`)},t.waitForElements=function(e,t=8e3){return new Promise(((n,i)=>{const r=document.querySelectorAll(e);if(r.length>0)n(r);else{let r=setTimeout((()=>{o.disconnect(),i(`waitForElements(${e}) - not found within timeout`)}),t);const o=new MutationObserver((t=>{for(const i of t)if("childList"===i.type){const t=document.querySelectorAll(e);t.length>0&&(o.disconnect(),clearTimeout(r),n(t))}}));o.observe(document.body,{childList:!0,subtree:!0})}}))},t.waitForElement=function(e,t=8e3){return new Promise(((n,i)=>{const r=document.querySelector(e);if(r)return n(r);{setTimeout((()=>{r.disconnect(),i(`${e} - not found within timeout`)}),t);const r=new MutationObserver((i=>{for(const o of i)if("childList"===o.type)for(const i of o.addedNodes)i.nodeType===Node.ELEMENT_NODE&&i.matches(e)&&(r.disconnect(),clearTimeout(t),n(i))}));r.observe(document.body,{childList:!0,subtree:!0})}}))},t.waitForElementInterval=function(e,t=o){const{timeout:n=8e3,fromNode:i=document,interval:r=333,retries:l}=t;return new Promise(((t,o)=>{const a=i.querySelector(e);if(a)t(a);else{const a=l?setTimeout((()=>{clearInterval(c),o(`${e} - not found within timeout`)}),n):void 0;let s=0;const c=setInterval((()=>{s++;const n=i.querySelector(e);n?(clearInterval(c),clearTimeout(a),t(n)):l&&s>=l&&(clearInterval(c),o(`${e} - not found within timeout`))}),r)}}))},t.waitForElementsInterval=function(e,t=o){const{timeout:n=8e3,fromNode:i=document,interval:r=333,retries:l}=t;return new Promise(((t,o)=>{const a=i.querySelectorAll(e);if(a.length>0)t(a);else{const a=l?setTimeout((()=>{clearInterval(c),o(`${e} - not found within timeout`)}),n):void 0;let s=0;const c=setInterval((()=>{s++;const n=i.querySelectorAll(e);n.length>0?(clearInterval(c),clearTimeout(a),t(n)):l&&s>=l&&(clearInterval(c),o(`${e} - not found within timeout`))}),r)}}))},t.waitForElementFromNode=function(e,t,n=8e3){return new Promise(((i,r)=>{const o=e.querySelector(t);if(o)return i(o);{const o=setTimeout((()=>{l.disconnect(),r(`${t} - not found within timeout`)}),n),l=new MutationObserver((e=>{for(const n of e)if("childList"===n.type)for(const e of n.addedNodes)e.nodeType===Node.ELEMENT_NODE&&e.matches(t)&&(l.disconnect(),clearTimeout(o),i(e))}));l.observe(e instanceof Document?e.body:e,{childList:!0,subtree:!0})}}))},t.onPageLoad=function(e){const t=()=>{const t=setTimeout((()=>{clearTimeout(t),setTimeout(e,2e3)}),500)};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",t):t()},t.mouseDownEvent=l,t.performComplexClick=function(e){return i(this,void 0,void 0,(function*(){e&&(console.log("performComplexClick() - window:",window),l(e),yield(0,r.addDelay)(50),a(e))}))},t.mouseUpEvent=a,t.triggerKeydown=function(e,t){const n=new KeyboardEvent("keydown",{key:t,bubbles:!0,cancelable:!0});e.dispatchEvent(n)},t.triggerPaste=function(e,t){const n=new ClipboardEvent("paste",{bubbles:!0,cancelable:!0,clipboardData:new DataTransfer});n.clipboardData?(n.clipboardData.setData("text/plain",t),e.dispatchEvent(n)):console.warn("triggerPaste() - clipboardData is null")},t.performComplexInput=function(e,t){e.focus();const n=new Event("focus",{bubbles:!0,cancelable:!0});e.dispatchEvent(n);for(let n of t){const t=new KeyboardEvent("keydown",{key:n,bubbles:!0,cancelable:!0});e.dispatchEvent(t);const i=new KeyboardEvent("keypress",{key:n,bubbles:!0,cancelable:!0});e.dispatchEvent(i),e.value+=n;const r=new Event("input",{bubbles:!0,cancelable:!0});e.dispatchEvent(r);const o=new KeyboardEvent("keyup",{key:n,bubbles:!0,cancelable:!0});e.dispatchEvent(o)}};const r=n(910);t.triggerHover=e=>{e&&e.dispatchEvent(new Event("mouseover",{bubbles:!0,cancelable:!0}))},t.cancelHover=e=>{e&&e.dispatchEvent(new Event("mouseout",{bubbles:!0,cancelable:!0}))};const o={timeout:8e3,fromNode:document,interval:333,retries:void 0};function l(e){const t=new MouseEvent("mousedown",{bubbles:!0,cancelable:!0});e&&e.dispatchEvent(t)}function a(e){const t=new MouseEvent("mouseup",{bubbles:!0,cancelable:!0});e?e.dispatchEvent(t):console.warn(`mouseUpEvent() - ${e} not found`)}}},t={};function n(i){var r=t[i];if(void 0!==r)return r.exports;var o=t[i]={exports:{}};return e[i].call(o.exports,o,o.exports,n),o.exports}n.d=(e,t)=>{for(var i in t)n.o(t,i)&&!n.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n(927)})();
//# sourceMappingURL=bundle.js.map